<!doctype html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Cache-Control" content="no-store, max-age=0">
  <title>NAVI-SIMS — Create User</title>
  <style>
/* ===== NAVI-SIMS Design System (create user) ===== */
:root{
  --bg:#F6F7FB; --card:#ffffff; --panel:#F9FAFB; --text:#0F172A; --muted:#64748B;
  --border:#E5E7EB; --ring:#2563EB; --primary:#2563EB; --danger:#EF4444;
  --radius:18px; --shadow:0 10px 30px rgba(2,6,23,.08);
}
@media (prefers-color-scheme: dark){
  :root{ --bg:#0B1220; --card:#0F172A; --panel:#111827; --text:#E5E7EB; --muted:#94A3B8; --border:#1F2937; --primary:#60A5FA; --shadow:0 10px 30px rgba(0,0,0,.45) }
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);min-height:100vh;display:flex;align-items:center;justify-content:center;font:400 16px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;}
.wrap{width:min(96vw,1100px)}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:26px;box-shadow:var(--shadow)}
.title{display:flex;align-items:center;gap:14px;margin-bottom:8px}
.logo-banner{width:min(38vw,200px);height:auto;display:block;object-fit:contain;background:#fff;border-radius:10px;box-shadow:0 0 0 1px var(--border), 0 3px 12px rgba(0,0,0,.06)}
.muted{color:var(--muted)}
.grid{display:grid;grid-template-columns:1fr;gap:16px}
@media (min-width:1024px){.grid{grid-template-columns:1fr 1fr}}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px}
.panel h3{margin:0 0 10px;font-size:1.04rem}
label{font-size:.9rem;color:var(--muted);display:block;margin:8px 0 6px}
input,select,textarea{
  width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;outline:none;background:#fff
}
@media (prefers-color-scheme: dark){ input,select,textarea{background:#0F172A;color:var(--text)} }
input:focus,select:focus,textarea:focus{border-color:var(--ring);box-shadow:0 0 0 4px color-mix(in oklab, var(--ring) 18%, transparent)}
input,select{height:44px}
textarea{min-height:92px;resize:vertical}
.row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.btn{background:var(--primary);color:#fff;border:none;border-radius:12px;padding:10px 14px;cursor:pointer}
.btn.alt{background:#334155;color:#fff}
.btn.soft{background:#E5E7EB;color:#111827}
.btn[disabled]{opacity:.6;cursor:not-allowed}
.msg{margin-top:10px;display:none;padding:10px;border-radius:10px}
.msg.ok{background:#E6FFED;color:#065F46;border:1px solid #A7F3D0}
.msg.err{background:#FEE2E2;color:#991B1B;border:1px solid #FECACA}
.hint,.note{font-size:.8rem;color:var(--muted)}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#EEF2FF;color:#3730A3;font-size:.78rem;border:1px solid #E0E7FF}
.divider{height:1px;background:var(--border);margin:10px 0}
.req::after{content:" *"; color:var(--danger)}
.pager-top { display:flex; align-items:center; justify-content:space-between; gap:10px; margin:-6px 0 10px; }
.steps { display:flex; gap:6px; align-items:center; }
.step-dot { width:9px; height:9px; border-radius:50%; background:#CBD5E1; border:1px solid #94A3B8; }
.step-dot.active { background:var(--primary); border-color:var(--primary); }
#detailsPager .page { display:none; }
#detailsPager .page.active { display:block; }
.pager-controls { display:flex; gap:10px; margin-top:12px; }
.pager-controls .btn.soft { background:#E5E7EB; color:#111827; }
@media (prefers-color-scheme: dark){
  .step-dot{ background:#1F2937; border-color:#374151 }
  .step-dot.active{ background:var(--primary); border-color:var(--primary) }
}
</style>
</head>
<body>
  <script src="js/api.js"></script>
  <script src="js/nav.js"></script>
  <script>requireAuth();</script>
  <div class="wrap">
    <div class="card">
      <div class="title">
        <img class="logo-banner" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='60'%3E%3Crect fill='%232563EB' width='200' height='60'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='white' font-family='Arial' font-size='18' font-weight='bold'%3ENAVI-SIMS%3C/text%3E%3C/svg%3E" alt="Logo">
        <div>
          <h2 style="margin:0">Create User</h2>
          <div class="muted" id="userLevelDisplay">Loading...</div>
        </div>
        <button id="btnBack" class="btn alt" type="button" style="margin-left:auto">Back</button>
      </div>

      <div class="grid">
        <div class="panel" id="card1">
          <h3>Create Login Information</h3>
          
          <label class="req" for="username">Username</label>
          <input id="username" type="text" required autocomplete="off">

          <label class="req" for="password">Password</label>
          <input id="password" type="text" required autocomplete="new-password">

          <label class="req" for="level">User Level</label>
          <select id="level" required>
            <option value="">— Select Level —</option>
          </select>
          <div class="hint">USER_ID prefix will be based on this level:
            <span class="badge">0 → 1xxxx</span>
            <span class="badge">1 → 2xxxx</span>
            <span class="badge">3 → 3xxxx</span>
          </div>

          <label class="req" for="group">User Group</label>
          <select id="group" required>
            <option value="">— Select Group —</option>
          </select>

          <div class="row">
            <button id="btnCreate" class="btn" type="button" disabled>Create User</button>
            <button id="btnReset1" class="btn alt" type="button">Reset</button>
          </div>

          <div id="msg1Ok" class="msg ok"></div>
          <div id="msg1Err" class="msg err"></div>

          <div id="createdBlock" style="display:none;margin-top:10px">
            <div class="divider"></div>
            <div class="hint">Generated USER_ID</div>
            <div id="createdUserId" class="badge"></div>
          </div>
        </div>

        <div class="panel" id="card2" style="display:none;">
          <div class="pager-top">
            <h3 id="card2Title" style="margin:0">User Details</h3>
            <div class="steps" id="steps"></div>
          </div>
          <div class="hint">Fill in additional details for USER_ID <span id="hUserId"></span></div>

          <div id="detailsPager"></div>

          <div class="pager-controls">
            <button id="btnPrev" class="btn soft" type="button">← Prev</button>
            <button id="btnNext" class="btn soft" type="button" style="margin-left:auto">Next →</button>
          </div>

          <div class="row">
            <button id="btnSaveDetails" class="btn" type="button">Save Details</button>
            <button id="btnReset2" class="btn alt" type="button">Reset</button>
          </div>

          <div id="msg2Ok" class="msg ok"></div>
          <div id="msg2Err" class="msg err"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
  const params = new URLSearchParams(window.location.search);
  const token = params.get('token') || localStorage.getItem('navi_token') || '';

  if (!token) {
    window.location.href = 'login.html?err=' + encodeURIComponent('Session expired');
  }

  // Load user session dynamically if needed
  let userInfo = null;
  async function loadSession() {
    try {
      const res = await API.getUserSessionInfo(token);
      if (res?.ok) userInfo = res.user;
    } catch (err) {
      console.error('Session load failed:', err);
    }
  }

  const ALLOWED_MIME = new Set([
    'application/pdf','application/msword','application/vnd.openxmlformats-officedocument.wordprocessingml.document',
    'application/vnd.ms-excel','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
    'application/vnd.ms-powerpoint','application/vnd.openxmlformats-officedocument.presentationml.presentation',
    'text/plain','image/jpeg','image/png','image/gif','image/webp','image/heic','image/heif','image/bmp','image/tiff'
  ]);
  const ALLOWED_EXT = new Set(['pdf','doc','docx','xls','xlsx','ppt','pptx','txt','jpg','jpeg','png','gif','webp','heic','heif','bmp','tif','tiff']);
  const MAX_FILE_MB = 15;

  function isAllowedFile(file) {
    if (!file) return false;
    const mimeOk = ALLOWED_MIME.has((file.type || '').toLowerCase());
    const ext = (file.name.split('.').pop() || '').toLowerCase();
    const extOk = ALLOWED_EXT.has(ext);
    const sizeOk = (file.size || 0) <= MAX_FILE_MB * 1024 * 1024;
    return (mimeOk || extOk) && sizeOk;
  }

  function explainFileProblem(file) {
    if (file && file.size > MAX_FILE_MB * 1024 * 1024) return `File too large (>${MAX_FILE_MB} MB): ${file.name}`;
    return `Unsupported type: ${file ? file.name : '(none)'}`;
  }

  let LEVELS = [], GROUPS = [];
  let CREATED_USER_ID = null, SELECTED_GROUP_ID = null, DETAIL_SCHEMA = null;

  const $ = (id) => document.getElementById(id);
  const on = (el, ev, fn) => { if (el) el.addEventListener(ev, fn); };

  function setMsg(which, ok, text) {
    const okBox  = $(`msg${which}Ok`), errBox = $(`msg${which}Err`);
    if (okBox) okBox.style.display = 'none';
    if (errBox) errBox.style.display = 'none';
    if (ok) { if (okBox) { okBox.textContent = text; okBox.style.display = 'block'; } }
    else   { if (errBox) { errBox.textContent = text; errBox.style.display = 'block'; } }
  }

  function enableCreateIfValid() {
    const u = ($('username')?.value || '').trim();
    const p = ($('password')?.value || '').trim();
    const l = ($('level')?.value || '').trim();
    const g = ($('group')?.value || '').trim();
    const valid = !!(u && p && l && g);
    $('btnCreate').disabled = !valid;
    return valid;
  }

  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const fr = new FileReader();
      fr.onload = () => resolve(fr.result);
      fr.onerror = reject;
      fr.readAsDataURL(file);
    });
  }

  const PAGE_SIZE = 8;
  let currentPage = 0, totalPages = 0;

  function renderSteps(container, count) {
    container.innerHTML = '';
    for (let i = 0; i < count; i++) {
      const dot = document.createElement('div');
      dot.className = 'step-dot' + (i === currentPage ? ' active' : '');
      dot.dataset.index = i;
      dot.title = `Step ${i+1} of ${count}`;
      dot.addEventListener('click', () => goToPage(i));
      container.appendChild(dot);
    }
  }

  function goToPage(n) {
    const pages = document.querySelectorAll('#detailsPager .page');
    if (!pages.length) return;
    currentPage = Math.max(0, Math.min(n, pages.length - 1));
    pages.forEach((p, i) => p.classList.toggle('active', i === currentPage));
    $('btnPrev').disabled = (currentPage === 0);
    $('btnNext').disabled = (currentPage === pages.length - 1);
    renderSteps($('steps'), pages.length);
  }

  function wirePagerKeys() {
    document.addEventListener('keydown', (e) => {
      if ($('card2').style.display === 'none') return;
      if (e.key === 'ArrowRight' && currentPage < totalPages - 1) goToPage(currentPage + 1);
      if (e.key === 'ArrowLeft'  && currentPage > 0)             goToPage(currentPage - 1);
    });
  }

  function buildDetailsForm(schema) {
    const pager = $('detailsPager');
    const cols = schema.columns || [];
    const fileCols = new Set(schema.fileColumns || []);

    const pieces = cols.map(col => {
      const label = col.replace(/_/g, ' ');
      if (fileCols.has(col)) {
        return `<label data-col="${col}">${label}</label><input type="file" data-col="${col}" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.jpg,.jpeg,.png,.gif,.webp,.heic,image/*">`;
      } else {
        const isTextArea = /ADDRESS/i.test(col);
        if (isTextArea) return `<label data-col="${col}">${label}</label><textarea data-col="${col}"></textarea>`;
        const type = /EMAIL/i.test(col) ? 'email' : (/PHONE|CONTACT/i.test(col) ? 'tel' : 'text');
        return `<label data-col="${col}">${label}</label><input type="${type}" data-col="${col}">`;
      }
    });

    pager.innerHTML = '';
    totalPages = Math.ceil(pieces.length / PAGE_SIZE) || 1;
    for (let i = 0; i < totalPages; i++) {
      const page = document.createElement('div');
      page.className = 'page' + (i === 0 ? ' active' : '');
      page.dataset.page = i;
      page.innerHTML = pieces.slice(i * PAGE_SIZE, (i + 1) * PAGE_SIZE).join('');
      pager.appendChild(page);
    }

    currentPage = 0;
    renderSteps($('steps'), totalPages);
    $('btnPrev').disabled = (totalPages <= 1);
    $('btnNext').disabled = (totalPages <= 1);

    if (!$('btnPrev').dataset.wired) {
      $('btnPrev').addEventListener('click', () => goToPage(currentPage - 1));
      $('btnNext').addEventListener('click', () => goToPage(currentPage + 1));
      $('btnPrev').dataset.wired = '1';
      $('btnNext').dataset.wired = '1';
      wirePagerKeys();
    }
  }

  async function ensureLevelGroupOptions() {
    try {
      const res = await API.getLevelGroupOptions();
      if (res?.ok) {
        LEVELS = res.levels || [];
        GROUPS = res.groups || [];
        fillLevelGroup(LEVELS, GROUPS);
      } else {
        $('level').innerHTML = '<option value="">(Load failed)</option>';
        $('group').innerHTML = '<option value="">(Load failed)</option>';
        setMsg(1, false, res?.msg || 'Failed to load level/group options.');
      }
    } catch (err) {
      $('level').innerHTML = '<option value="">(Load failed)</option>';
      $('group').innerHTML = '<option value="">(Load failed)</option>';
      setMsg(1, false, err?.message || 'Failed to load level/group options.');
    }
  }

  function fillLevelGroup(levels, groups) {
    const levelSelect = $('level'), groupSelect = $('group');
    if (Array.isArray(levels) && levels.length) {
      levelSelect.innerHTML = '<option value="">— Select Level —</option>' +
        levels.map(l => `<option value="${l.id}">${l.id} — ${l.name}</option>`).join('');
    } else {
      levelSelect.innerHTML = '<option value="">(No levels found)</option>';
    }
    if (Array.isArray(groups) && groups.length) {
      groupSelect.innerHTML = '<option value="">— Select Group —</option>' +
        groups.map(g => `<option value="${g.id}">${g.id} — ${g.name}</option>`).join('');
    } else {
      groupSelect.innerHTML = '<option value="">(No groups found)</option>';
    }
  }

  document.addEventListener('DOMContentLoaded', async () => {
    // Load user session to show level
    try {
      const res = await API.getUserSessionInfo(token);
      if (res?.ok && res.user) {
        $('userLevelDisplay').textContent = `Your level: ${res.user.levelName || '—'}`;
      }
    } catch (err) {
      console.error('Failed to load user session:', err);
    }

    ensureLevelGroupOptions();

    on($('btnBack'), 'click', () => {
      window.location.href = `dashboard.html?token=${encodeURIComponent(token)}`;
    });

    ['username','password','level','group'].forEach(id=>{
      const el = $(id);
      if (!el) return;
      ['input','change','keyup','blur'].forEach(ev => on(el, ev, enableCreateIfValid));
    });

    on($('group'), 'change', (e) => {
      SELECTED_GROUP_ID = e.target.value;
      if (CREATED_USER_ID && SELECTED_GROUP_ID) loadDetailSchema();
    });

    on($('btnCreate'), 'click', async () => {
      if (!enableCreateIfValid()) return;

      setMsg(1, true, ''); setMsg(1, false, '');
      const payload = {
        username: ($('username').value || '').trim(),
        password: ($('password').value || '').trim(),
        levelId:  ($('level').value || '').trim(),
        groupId:  ($('group').value || '').trim()
      };

      try {
        const res = await API.createUserSubmit(token, payload);
        if (!res?.ok) { setMsg(1,false,res?.msg||'Failed to create user.'); return; }
        CREATED_USER_ID = res.userId;
        SELECTED_GROUP_ID = payload.groupId;
        $('createdUserId').textContent = CREATED_USER_ID;
        $('createdBlock').style.display = 'inline-block';
        setMsg(1, true, 'User created successfully!');
        $('hUserId').textContent = CREATED_USER_ID;
        loadDetailSchema();
      } catch (err) {
        setMsg(1,false, err?.message||'Unexpected error.');
      }
    });

    on($('btnSaveDetails'), 'click', async () => {
      setMsg(2, true, ''); setMsg(2, false, '');
      if (!CREATED_USER_ID || !SELECTED_GROUP_ID || !DETAIL_SCHEMA) {
        setMsg(2, false, 'Create a user first.'); return;
      }
      const fileCols = new Set(DETAIL_SCHEMA.fileColumns || []);
      const values = {}, files = {};
      const controls = document.querySelectorAll('#detailsPager [data-col]');
      try {
        for (const el of controls) {
          const col = el.getAttribute('data-col'); if (!col) continue;
          if (fileCols.has(col)) {
            const f = el.files && el.files[0];
            if (f) {
              if (!isAllowedFile(f)) {
                setMsg(2, false, explainFileProblem(f));
                return;
              }
              files[col] = { name:f.name, mime:f.type, dataBase64: await fileToBase64(f) };
            }
          } else {
            values[col] = (el.value || '').trim();
          }
        }
        const res = await API.saveDetailForm(token, { userId:CREATED_USER_ID, groupId:SELECTED_GROUP_ID, values, files });
        if(!res?.ok){ setMsg(2,false,res?.msg||'Failed to save details.'); return; }
        setMsg(2,true,res.msg||'Details saved successfully!');
      } catch (err) {
        setMsg(2, false, 'Error: ' + err.message);
      }
    });

    on($('btnReset1'), 'click', () => {
      ['username','password','level','group'].forEach(id=>{ const el=$(id); if(el) el.value=''; });
      setMsg(1, true, ''); setMsg(1, false, '');
      $('btnCreate').disabled = true;
      $('card2').style.display='none'; $('createdBlock').style.display='none';
      CREATED_USER_ID=null; SELECTED_GROUP_ID=null; DETAIL_SCHEMA=null;
    });

    on($('btnReset2'), 'click', () => {
      if (DETAIL_SCHEMA) buildDetailsForm(DETAIL_SCHEMA);
      setMsg(2, true, ''); setMsg(2, false, '');
    });

    async function loadDetailSchema() {
      try {
        const schema = await API.getDetailFormSchema(token, SELECTED_GROUP_ID);
        $('card2').style.display='block';
        if(!schema?.ok){ setMsg(2,false,schema?.msg||'Failed to load detail form.'); return; }
        DETAIL_SCHEMA = schema;
        buildDetailsForm(schema);
        $('card2Title').textContent = (SELECTED_GROUP_ID === '0') ? 'Client Details' : 'Staff Details';
        setMsg(2,true,'');
      } catch (err) {
        $('card2').style.display='block';
        setMsg(2,false, err?.message||'Unexpected error.');
      }
    }
  });
  </script>
</body>
</html>