<!doctype html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Cache-Control" content="no-store, max-age=0">
  <title>NAVI-SIMS â€” Change Password</title>
  <style>
/* ===== NAVI-SIMS Design System (change password) ===== */
:root{
  --bg:#F6F7FB; --card:#ffffff; --panel:#F9FAFB; --text:#0F172A; --muted:#64748B;
  --border:#E5E7EB; --ring:#2563EB; --primary:#2563EB; --danger:#EF4444; --success:#10B981; --warning:#F59E0B;
  --radius:18px; --shadow:0 10px 30px rgba(2,6,23,.08);
}
@media (prefers-color-scheme: dark){
  :root{ --bg:#0B1220; --card:#0F172A; --panel:#111827; --text:#E5E7EB; --muted:#94A3B8; --border:#1F2937; --primary:#60A5FA; --shadow:0 10px 30px rgba(0,0,0,.45) }
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);min-height:100vh;display:flex;align-items:center;justify-content:center;font:400 16px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;}
.wrap{width:min(96vw,600px)}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:32px 28px;box-shadow:var(--shadow)}
.title{display:flex;align-items:center;gap:14px;margin-bottom:16px}
.logo-banner{width:min(25vw,120px);height:auto;display:block;object-fit:contain;background:#fff;border-radius:8px;box-shadow:0 0 0 1px var(--border), 0 2px 8px rgba(0,0,0,.06)}
.muted{color:var(--muted)}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:20px;margin:16px 0}
.panel h3{margin:0 0 12px;font-size:1.1rem}
label{font-size:.9rem;color:var(--muted);display:block;margin:12px 0 6px}
.input-wrap{position:relative;margin-bottom:20px}
input[type="password"]{width:100%;padding:12px 14px;padding-right:78px;border:1px solid var(--border);border-radius:12px;outline:none;background:#fff;font-size:16px;height:46px}
@media (prefers-color-scheme: dark){ input[type="password"]{background:#0F172A;color:var(--text)} }
input:focus{border-color:var(--ring);box-shadow:0 0 0 4px color-mix(in oklab, var(--ring) 18%, transparent)}
.toggle-btn{position:absolute;right:8px;top:50%;transform:translateY(-50%);height:32px;padding:0 12px;font-size:.82rem;border:1px solid var(--border);border-radius:8px;background:#F8FAFC;color:#334155;cursor:pointer}
@media (prefers-color-scheme: dark){ .toggle-btn{background:#111827;color:#E5E7EB} }
.toggle-btn:active{transform:translateY(-50%) scale(.98)}
.password-strength{height:4px;background:#E5E7EB;border-radius:2px;overflow:hidden;margin-top:8px}
.password-strength .bar{height:100%;width:0%;transition:all .3s ease;border-radius:2px}
.strength-weak .bar{width:33%;background:var(--danger)}
.strength-medium .bar{width:66%;background:var(--warning)}
.strength-strong .bar{width:100%;background:var(--success)}
.requirements{margin-top:12px;font-size:.85rem;color:var(--muted)}
.requirements ul{margin:8px 0;padding-left:20px}
.requirements li{margin:4px 0}
.requirements li.valid{color:var(--success)}
.requirements li.invalid{color:var(--danger)}
.row{display:flex;gap:12px;flex-wrap:wrap;margin-top:20px}
.btn{background:var(--primary);color:#fff;border:none;border-radius:12px;padding:12px 16px;cursor:pointer;font-weight:600}
.btn.alt{background:#6B7280;color:#fff}
.btn[disabled]{opacity:.6;cursor:not-allowed}
.msg{margin-top:12px;display:none;padding:12px;border-radius:10px}
.msg.ok{background:#E6FFED;color:#065F46;border:1px solid #A7F3D0}
.msg.err{background:#FEE2E2;color:#991B1B;border:1px solid #FECACA}
.security-tips{background:#F0F9FF;border:1px solid #7DD3FC;border-radius:10px;padding:16px;margin-top:16px}
.security-tips h4{margin:0 0 8px;color:#0369A1;font-size:.95rem}
.security-tips ul{margin:8px 0;padding-left:20px;font-size:.85rem;color:#0369A1}
.security-tips li{margin:3px 0}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="title">
        <img class="logo-banner" src="<?!= logoUrl ?>" alt="Logo" onerror="this.style.display='none'">
        <div>
          <h2 style="margin:0">Change Password</h2>
          <div class="muted">User: <?= username || 'Unknown' ?></div>
        </div>
        <button id="btnBack" class="btn alt" type="button" style="margin-left:auto">Back</button>
      </div>

      <div class="panel">
        <h3>Update Your Password</h3>
        
        <div class="input-wrap">
          <label for="currentPassword">Current Password</label>
          <input id="currentPassword" type="password" required autocomplete="current-password">
          <button id="toggleCurrent" class="toggle-btn" type="button">Show</button>
        </div>

        <div class="input-wrap">
          <label for="newPassword">New Password</label>
          <input id="newPassword" type="password" required autocomplete="new-password">
          <button id="toggleNew" class="toggle-btn" type="button">Show</button>
          <div class="password-strength" id="passwordStrength">
            <div class="bar"></div>
          </div>
          
          <div class="requirements">
            <strong>Password Requirements:</strong>
            <ul id="reqList">
              <li id="reqLength" class="invalid">At least <?= minLength || 8 ?> characters</li>
              <li id="reqUpper" class="invalid">One uppercase letter (A-Z)</li>
              <li id="reqLower" class="invalid">One lowercase letter (a-z)</li>
              <li id="reqNumber" class="invalid">One number (0-9)</li>
              <? if (requireSpecial) { ?>
                <li id="reqSpecial" class="invalid">One special character (!@#$%^&*)</li>
              <? } ?>
            </ul>
          </div>
        </div>

        <div class="input-wrap">
          <label for="confirmPassword">Confirm New Password</label>
          <input id="confirmPassword" type="password" required autocomplete="new-password">
          <button id="toggleConfirm" class="toggle-btn" type="button">Show</button>
        </div>

        <div class="row">
          <button id="btnChange" class="btn" type="button" disabled>Change Password</button>
          <button id="btnReset" class="btn alt" type="button">Reset Form</button>
        </div>

        <div id="msgOk" class="msg ok"></div>
        <div id="msgErr" class="msg err"></div>
      </div>

      <div class="security-tips">
        <h4>ðŸ”’ Password Security Tips</h4>
        <ul>
          <li>Use a unique password not used elsewhere</li>
          <li>Consider using a passphrase with multiple words</li>
          <li>Avoid personal information like names or dates</li>
          <li>Change your password if you suspect it's compromised</li>
          <li>Never share your password with others</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    const token = "<?= token ?>";
    const appUrl = "<?= appUrl ?>";
    const minLength = <?= minLength || 8 ?>;
    const requireSpecial = <?= requireSpecial ? 'true' : 'false' ?>;

    const $ = (id) => document.getElementById(id);
    const currentPw = $('currentPassword');
    const newPw = $('newPassword');
    const confirmPw = $('confirmPassword');
    const strengthIndicator = $('passwordStrength');
    const btnChange = $('btnChange');

    // Toggle visibility functions
    function setupToggle(inputId, toggleId) {
      const input = $(inputId);
      const toggle = $(toggleId);
      toggle.addEventListener('click', () => {
        const isPassword = input.type === 'password';
        input.type = isPassword ? 'text' : 'password';
        toggle.textContent = isPassword ? 'Hide' : 'Show';
      });
    }

    setupToggle('currentPassword', 'toggleCurrent');
    setupToggle('newPassword', 'toggleNew');
    setupToggle('confirmPassword', 'toggleConfirm');

    function setMsg(ok, text) {
      const okBox = $('msgOk');
      const errBox = $('msgErr');
      okBox.style.display = 'none';
      errBox.style.display = 'none';
      if (ok) {
        okBox.textContent = text;
        okBox.style.display = 'block';
      } else {
        errBox.textContent = text;
        errBox.style.display = 'block';
      }
    }

    function validatePassword(password) {
      const checks = {
        length: password.length >= minLength,
        upper: /[A-Z]/.test(password),
        lower: /[a-z]/.test(password),
        number: /\d/.test(password),
        special: requireSpecial ? /[!@#$%^&*(),.?":{}|<>]/.test(password) : true
      };

      // Update UI indicators
      $('reqLength').className = checks.length ? 'valid' : 'invalid';
      $('reqUpper').className = checks.upper ? 'valid' : 'invalid';
      $('reqLower').className = checks.lower ? 'valid' : 'invalid';
      $('reqNumber').className = checks.number ? 'valid' : 'invalid';
      if (requireSpecial) {
        $('reqSpecial').className = checks.special ? 'valid' : 'invalid';
      }

      // Calculate strength
      const validChecks = Object.values(checks).filter(Boolean).length;
      const totalChecks = requireSpecial ? 5 : 4;
      
      let strength = 'weak';
      if (validChecks === totalChecks && password.length >= 12) strength = 'strong';
      else if (validChecks >= Math.ceil(totalChecks * 0.75)) strength = 'medium';

      strengthIndicator.className = `password-strength strength-${strength}`;

      return Object.values(checks).every(Boolean);
    }

    function checkFormValidity() {
      const currentValid = currentPw.value.length > 0;
      const newValid = validatePassword(newPw.value);
      const confirmValid = newPw.value === confirmPw.value && confirmPw.value.length > 0;
      
      btnChange.disabled = !(currentValid && newValid && confirmValid);
      
      // Show confirmation mismatch error
      if (confirmPw.value && !confirmValid && newPw.value === confirmPw.value) {
        // passwords match but new password isn't valid
      } else if (confirmPw.value && newPw.value !== confirmPw.value) {
        // passwords don't match - could show inline error
      }
    }

    // Event listeners
    newPw.addEventListener('input', () => {
      validatePassword(newPw.value);
      checkFormValidity();
    });

    [currentPw, confirmPw].forEach(input => {
      input.addEventListener('input', checkFormValidity);
    });

    // Change password
    $('btnChange').addEventListener('click', () => {
      setMsg(true, '');
      setMsg(false, '');

      const current = currentPw.value;
      const newPassword = newPw.value;
      const confirm = confirmPw.value;

      if (newPassword !== confirm) {
        setMsg(false, 'New passwords do not match.');
        return;
      }

      if (current === newPassword) {
        setMsg(false, 'New password must be different from current password.');
        return;
      }

      btnChange.disabled = true;
      btnChange.textContent = 'Changing...';

      google.script.run
        .withSuccessHandler((res) => {
          btnChange.disabled = false;
          btnChange.textContent = 'Change Password';
          
          if (!res?.ok) {
            setMsg(false, res?.msg || 'Failed to change password.');
            return;
          }
          
          setMsg(true, 'Password changed successfully!');
          
          // Clear form
          currentPw.value = '';
          newPw.value = '';
          confirmPw.value = '';
          strengthIndicator.className = 'password-strength';
          
          // Reset requirement indicators
          document.querySelectorAll('#reqList li').forEach(li => {
            li.className = 'invalid';
          });
          
          checkFormValidity();
        })
        .withFailureHandler((err) => {
          btnChange.disabled = false;
          btnChange.textContent = 'Change Password';
          setMsg(false, err?.message || 'Unexpected error occurred.');
        })
        .changePassword(token, current, newPassword);
    });

    // Reset form
    $('btnReset').addEventListener('click', () => {
      currentPw.value = '';
      newPw.value = '';
      confirmPw.value = '';
      strengthIndicator.className = 'password-strength';
      
      document.querySelectorAll('#reqList li').forEach(li => {
        li.className = 'invalid';
      });
      
      setMsg(true, '');
      setMsg(false, '');
      checkFormValidity();
      currentPw.focus();
    });

    // Back button
    $('btnBack').addEventListener('click', () => {
      window.top.location.href = `${appUrl}?page=dashboard&token=${encodeURIComponent(token)}`;
    });

    // Initial focus
    currentPw.focus();
  </script>
</body>
</html>