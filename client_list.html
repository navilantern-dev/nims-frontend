<!doctype html>
<html>
<head>
  <script src="js/nav.js"></script>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Cache-Control" content="no-store, max-age=0">
  <title>NAVI-SIMS â€” Client List</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.css">
  <style>
    /* ===== NAVI-SIMS Design System ===== */
    :root {
      --bg: #F6F7FB; --card: #ffffff; --panel: #F9FAFB; --text: #0F172A; --muted: #64748B;
      --border: #E5E7EB; --ring: #2563EB; --primary: #2563EB; --danger: #EF4444; --ok: #059669;
      --radius: 18px; --shadow: 0 10px 30px rgba(2, 6, 23, .08);
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0B1220; --card: #0F172A; --panel: #020617; --text: #F8FAFC; --muted: #94A3B8;
        --border: #1E293B; --ring: #3B82F6; --primary: #3B82F6; --danger: #F87171; --ok: #10B981;
      }
    }
    body {
      background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif;
      margin: 0; padding: 2rem; -webkit-font-smoothing: antialiased;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    .card { background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); padding: 2rem; }
    h1 { font-size: 1.75rem; font-weight: 600; margin: 0 0 1rem; }
    .search-bar { display: flex; gap: 1rem; margin-bottom: 1.5rem; }
    .search-bar select, .search-bar input {
      padding: 0.75rem 1rem; border-radius: 12px; border: 1px solid var(--border);
      background: var(--panel); color: var(--text); font-size: 1rem;
    }
    .search-bar input { flex-grow: 1; }
    .loading { display: none; align-items: center; justify-content: center; padding: 2rem; }
    .loading .fa-spinner { font-size: 2rem; color: var(--primary); }
    .msg-ok { color: var(--ok); }
    .msg-err { color: var(--danger); }
    #clientTable_wrapper { margin-top: 1rem; }
    .dataTables_filter { display: none; }
    .back-button {
      position: absolute;
      top: 1.5rem;
      right: 2rem;
      text-decoration: none;
      background-color: var(--panel);
      color: var(--muted);
      padding: 0.6rem 1.2rem;
      border-radius: 12px;
      font-weight: 500;
      transition: all 0.2s ease-in-out;
      border: 1px solid var(--border);
      display: inline-flex;
      align-items: center;
    }
    .back-button:hover {
      background-color: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    .back-button i {
      margin-right: 0.5rem;
    }
  </style>
</head>
<body>
  <a id="backButton" class="back-button" href="#">
    <i class="fa-solid fa-arrow-left"></i> Back to Dashboard
  </a>
  <div class="container">
    <div class="card">
      <h1><i class="fa-solid fa-users"></i> Client List</h1>
      <p style="color:var(--muted); margin-top: -1rem; margin-bottom: 2rem;">Browse and manage registered client companies.</p>

      <div class="search-bar">
        <select id="searchType">
          <option value="COMP_NAME">Company Name</option>
          <option value="COMP_REGNO">Registration No.</option>
          <option value="COMP_EMAIL">Email</option>
        </select>
        <input type="text" id="searchValue" placeholder="Type to search...">
      </div>

      <div id="loading" class="loading">
        <i class="fa-solid fa-spinner fa-spin"></i>
      </div>
      <div id="msg" style="margin: 1rem 0;"></div>

      <table id="clientTable" class="display" style="width:100%"></table>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
  <script src="https://cdn.datatables.net/2.0.8/js/dataTables.js"></script>
  <script>
    const $ = (id) => document.getElementById(id);
    const appUrl = '<?= ScriptApp.getService().getUrl() ?>';
    const token = '<?= token ?>';
    // --------------------------------------------------------------------------

    let table;

    function showLoading(isLoading) {
      $('loading').style.display = isLoading ? 'flex' : 'none';
    }

    function setMsg(ok, msg) {
      const el = $('msg');
      el.textContent = msg;
      el.className = ok ? 'msg-ok' : 'msg-err';
      el.style.display = msg ? 'block' : 'none';
    }

    function initTable(data) {
      if (table) {
        table.destroy();
      }
      table = new DataTable('#clientTable', {
        data: data,
        columns: [
          { data: 'COMP_NAME', title: 'Company Name' },
          { data: 'COMP_REGNO', title: 'Registration No.' },
          { data: 'COMP_CONTACT_M', title: 'Mobile' },
          { data: 'COMP_EMAIL', title: 'Email' },
          {
            data: 'COMP_ID',
            title: 'Actions',
            render: function(data, type, row) {
              return `<i class="fa-solid fa-eye" style="cursor:pointer;" onclick="viewClientProfile('${data}')"></span></i>`;
            },
            orderable: false,
            searchable: false
          }
        ],
        paging: true,
        ordering: true,
        info: true,
        responsive: true,
        searching: false
      });
    }

    function viewClientProfile(clientId) { 
      if (!token) {
        setMsg(false, 'Session token is missing. Please log in again.');
        return;
      }
      
      const redirectUrl = `${appUrl}?page=client_profile&client_id=${clientId}&token=${encodeURIComponent(token)}&from=client_list`;
      console.log("Redirecting to:", redirectUrl); //debug
      window.top.location.href = redirectUrl;
    }

    async function loadClientData(searchQuery) {
      if (!token) {
        setMsg(false, 'Authentication token is missing. Please reload and log in.');
        return;
      }
      showLoading(true);
      setMsg(true, '');
      try {
        const result = await new Promise((resolve, reject) => {
          API
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .getClientList(token, searchQuery);
        });

        if (result.ok) {
          initTable(result.data);
          setMsg(true, result.data.length > 0 ? 'Client list loaded.' : 'No clients found.');
        } else {
          setMsg(false, result.msg || 'Failed to load client list.');
        }
      } catch (e) {
        setMsg(false, e.message || 'An unexpected error occurred.');
      } finally {
        showLoading(false);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      if (!token || token === 'undefined') {
        setMsg(false, 'Critical error: No session token found. Please log in again.');
        return;
      }

      const dashboardUrl = `${appUrl}?page=dashboard&token=${encodeURIComponent(token)}`;
      $('backButton').href = dashboardUrl;
    
      loadClientData(null);

      let searchTimeout;
      $('searchValue').addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          const searchType = $('searchType').value;
          const searchValue = $('searchValue').value.trim();
          const searchQuery = searchValue ? { [searchType]: searchValue } : null;
          loadClientData(searchQuery);
        }, 500);
      });
      
      $('searchType').addEventListener('change', () => {
        const searchType = $('searchType').value;
        const searchValue = $('searchValue').value.trim();
        if (searchValue) {
          const searchQuery = { [searchType]: searchValue };
          loadClientData(searchQuery);
        }
      });
    });
  </script>
</body>
</html>