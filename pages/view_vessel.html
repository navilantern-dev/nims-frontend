<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>NAVI-SIMS – View Vessel</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Oswald:wght@700&display=swap');
    :root { --bg: #F6F7FB; --card: #ffffff; --panel: #F9FAFB; --text: #0F172A; --muted: #64748B; --border: #E5E7EB; --ring: #2563EB; --primary: #2563EB; --danger: #EF4444; --ok: #16A34A; --radius: 18px; --shadow: 0 10px 30px rgba(2, 6, 23, .08); }
    @media (prefers-color-scheme: dark) { :root { --bg: #0B1220; --card: #0F172A; --panel: #111827; --text: #E5E7EB; --muted: #9AA4B2; --border: #1F2937; --shadow: 0 10px 30px rgba(0, 0, 0, .5); } }
    body { margin: 0; font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; color: var(--text); background: var(--bg); }
    .wrap { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    .h1 { font-size: 22px; font-weight: 700; margin: 6px 0 16px; }
    .cards { width: 100%; display: grid; grid-template-columns: 1fr; gap: 16px; }
    .card { width: 100%; background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); padding: 16px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .field { display: flex; flex-direction: column; gap: 6px; min-width: 220px; }
    label { font-weight: 600; color: var(--muted); }
    select, input[type="text"], button { padding: 10px 12px; border: 1px solid var(--border); border-radius: 10px; background: var(--panel); color: var(--text); }
    .btn { background: var(--primary); color: #fff; border: none; cursor: pointer; }
    .btn.alt { background: transparent; border: 1px solid var(--border); color: var(--text); }
    .btn.small { padding: 8px 10px; border-radius: 8px; font-size: 13px; }
    .list { border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
    .list .item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-top: 1px solid var(--border); background: var(--card); }
    .list .item:first-child { border-top: none; }
    .muted { color: var(--muted); }
    .banner-container { width: 100%; text-align: center; padding: 2rem 1rem; background: #ffffff; border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 2rem; }
    .banner-heading { font-family: "Arial Unicode MS", Arial, sans-serif; font-weight: 700; font-size: clamp(3rem, 12vw, 6rem); letter-spacing: 0.65vw; margin: 0 -1rem 0; }
    .banner-heading .part-one { color: #231F20; }
    .banner-heading .part-two { color: #965A37; }
    .banner-subheading { font-family: 'Montserrat', sans-serif; text-transform: uppercase; color: #231F20; letter-spacing: 5px; margin-top: 0; font-weight: 500; font-size: clamp(0.6rem, 2.5vw, 0.9rem); }
    .modal-back { position: fixed; inset: 0; background: rgba(0, 0, 0, .35); display: none; align-items: center; justify-content: center; padding: 24px; z-index: 100; }
    .modal { width: min(900px, 100%); background: var(--card); border: 1px solid var(--border); border-radius: 16px; box-shadow: var(--shadow); }
    .modal .hd { padding: 14px 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .modal .bd { padding: 16px; max-height: 70vh; overflow: auto; }
    .modal .ft { padding: 12px 16px; border-top: 1px solid var(--border); display: flex; gap: 8px; justify-content: flex-end; }
    .tbl { width: 100%; border-collapse: collapse; }
    .tbl th, .tbl td { padding: 8px 10px; border-bottom: 1px solid var(--border); text-align: left; vertical-align: top; }
    .sec { margin: 12px 0 6px; font-weight: 700; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="banner-container">
      <h1 class="banner-heading"><span class="part-one">NAVI</span><span class="part-two">LANTERN</span></h1>
      <p class="banner-subheading">NAVAL ARCHITECTURE . MARINE SURVEY . MARINE ENGINEERING</p>
    </div>

    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px;">
      <div class="h1" style="margin:0">View Vessel</div>
      <button id="btnBack" class="btn alt small">← Back</button>
    </div>

    <div class="cards">
      <div class="card">
        <div class="row" style="margin-bottom:8px;justify-content:space-between;align-items:center">
          <div><strong>Vessels</strong> <span class="muted" id="vCount"></span></div>
          <div class="row">
            <button id="btnExportCsv" class="btn alt small">Export CSV</button>
          </div>
        </div>
        <div id="vList" class="list"></div>
      </div>
    </div>
  </div>

  <div id="modalBack" class="modal-back">
    <div class="modal">
      <div class="hd">
        <div><strong id="mTitle">Vessel Detail</strong></div>
        <div class="muted" id="mSub"></div>
      </div>
      <div class="bd" id="mBody"></div>
      <div class="ft">
        <button id="btnPrint" class="btn alt">Print</button>
        <button id="btnClose" class="btn">Close</button>
      </div>
    </div>
  </div>

  <script src="../assets/js/bridge.js"></script>
  <script>
    (async function() {
      const user = await NAVI.Guards.requireAuth();
      if (!user) return;

      const $ = (id) => document.getElementById(id);
      let ALL = [];

      function drawList() {
        const box = $('vList');
        box.innerHTML = '';
        $('vCount').textContent = `${ALL.length} vessel(s)`;
        
        if (!ALL.length) {
          box.innerHTML = '<div class="item"><span class="muted">No vessels found</span></div>';
          return;
        }

        ALL.forEach(v => {
          const item = document.createElement('div');
          item.className = 'item';
          item.innerHTML = `
            <div>
              <div><strong>${v.SHIP_NAME || '—'}</strong></div>
              <div class="muted">${v.OWNER_NAME || '—'}</div>
            </div>
            <button class="btn small" onclick="openDetail('${v.SHIP_ID}')">View Detail</button>
          `;
          box.appendChild(item);
        });
      }

      window.openDetail = async (shipId) => {
        try {
          const res = await NAVI.API.vessels.detail(shipId);
          if (!res?.ok) { alert(res?.msg || 'Failed to load detail'); return; }
          
          const m = res.main || {};
          $('mTitle').textContent = m.SHIP_NAME || 'Vessel Detail';
          $('mSub').textContent = m.OWNER_NAME || '';
          
          $('mBody').innerHTML = `
            <div class="sec">Vessel Main Info</div>
            <table class="tbl">
              <tr><th>Ship Name</th><td>${m.SHIP_NAME || '—'}</td></tr>
              <tr><th>Owner Name</th><td>${m.OWNER_NAME || '—'}</td></tr>
              <tr><th>Official Number</th><td>${m.OFFICIAL_NO || '—'}</td></tr>
              <tr><th>IMO Number</th><td>${m.IMO_NO || '—'}</td></tr>
              <tr><th>Ship Type</th><td>${m.SHIP_TYPE || '—'}</td></tr>
            </table>
          `;
          
          $('modalBack').style.display = 'flex';
        } catch (err) {
          alert(err?.message || 'Unexpected error');
        }
      };

      $('btnClose').addEventListener('click', () => $('modalBack').style.display = 'none');
      $('btnPrint').addEventListener('click', () => window.print());

      $('btnExportCsv').addEventListener('click', () => {
        const csv = [
          ['Ship Name', 'Owner Name', 'Ship ID'],
          ...ALL.map(v => [v.SHIP_NAME, v.OWNER_NAME, v.SHIP_ID])
        ].map(r => r.map(c => `"${(c || '').replace(/"/g, '""')}"`).join(',')).join('\n');
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `vessels_${new Date().toISOString().slice(0, 10)}.csv`;
        document.body.appendChild(a);
        a.click();
        URL.revokeObjectURL(a.href);
        a.remove();
      });

      $('btnBack').addEventListener('click', () => window.location.href = './dashboard.html');

      try {
        const res = await NAVI.API.vessels.list();
        if (res?.ok) {
          ALL = Array.isArray(res.vessels) ? res.vessels : [];
          drawList();
        } else {
          alert(res?.msg || 'Failed to load vessels');
        }
      } catch (err) {
        alert(err?.message || 'Unexpected error');
      }
    })();
  </script>
</body>
</html>