<!doctype html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Cache-Control" content="no-store, max-age=0">
  <title>NAVI-SIMS — Dashboard</title>
  <style>
  :root{
    --bg:#0b1422; --card:#0f1b2e; --panel:#0c1726; --text:#e6edf3; --muted:#93a7c0;
    --border:#1f2a3b; --ring:#2563EB; --primary:#2563EB; --danger:#EF4444; --ok:#16A34A; --warn:#D97706;
    --radius:18px; --shadow:0 10px 30px rgba(2,6,23,.25);
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  .wrap{max-width:1200px;margin:32px auto;padding:0 16px}
  .logo-card{background:#fff;border-radius:28px;box-shadow:var(--shadow);padding:18px;display:flex;align-items:center;justify-content:center;margin-bottom:24px}
  .logo-card img{max-width:100%;height:72px;object-fit:contain}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:22px;margin-bottom:20px}
  h2{font-size:28px;margin:0 0 12px 0;letter-spacing:.2px}
  .pill{display:inline-flex;align-items:center;gap:8px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:999px;padding:6px 12px;margin-right:8px}
  .row{display:flex;flex-wrap:wrap;gap:10px}
  .btn, .btn-outline{
    appearance:none;border-radius:14px;padding:10px 14px;font-weight:600;border:1px solid transparent;cursor:pointer;
  }
  .btn{background:var(--primary);color:#fff}
  .btn-outline{background:transparent;border-color:var(--border);color:var(--text)}
  .btn-danger{background:var(--danger);color:#fff}
  .btn:focus,.btn-outline:focus,.btn-danger:focus{outline:2px solid var(--ring);outline-offset:2px}
  .status{display:flex;align-items:center;gap:8px;margin-top:8px;color:var(--muted)}
  .dot{width:10px;height:10px;border-radius:50%}
  .dot.secure{background:var(--ok)}
  .modules{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
  .module{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px}
  .module h3{margin:0 0 6px 0;font-size:18px}
  .hr{height:1px;background:var(--border);margin:16px 0}
  footer{color:var(--muted);font-size:12px;text-align:center;margin:20px 0 40px}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Brand / Logo (optional, hidden if URL missing) -->
    <div class="logo-card">
      <img id="userLogo" alt="NAVI-LANTERN Logo" onerror="this.style.display='none'">
    </div>

    <!-- Welcome / Identity -->
    <div class="card">
      <h2>Welcome, <span id="welcomeName">—</span></h2>
      <div class="row" style="margin-bottom:8px">
        <div class="pill">Level: <span id="pillLevel">—</span></div>
        <div class="pill">Group: <span id="pillGroup">—</span></div>
        <div class="pill">ID: <span id="pillId">—</span></div>
      </div>
      <div class="status">
        <span class="dot secure" id="securityIndicator"></span>
        <span id="securityText">Secure session active</span>
      </div>
      <div class="hr"></div>
      <div class="row">
        <button type="button" class="btn-outline" id="btnChangePassword">Change Password</button>
        <button type="button" class="btn-outline" id="btnSecurityInfo">Security Info</button>
        <div style="flex:1"></div>
        <button type="button" class="btn-danger" id="btnLogout">Secure Logout</button>
      </div>
    </div>

    <!-- Dynamic modules render here -->
    <div class="modules" id="modulesContainer"></div>

    <!-- Optional quick stats (visible for super/admin only) -->
    <div class="modules" id="quickStats" style="display:none">
      <div class="module">
        <h3>👤 Total Users</h3>
        <p style="font-size:28px;margin:8px 0 0 0" id="totalUsers">—</p>
      </div>
    </div>

    <footer>© NAVI-LANTERN</footer>
  </div>

  <!-- Your config & bridge -->
  <script src="./js/config.js"></script>
  <script src="./js/bridge.js"></script>

  <script>
  (async () => {
    // 1) Require auth & get normalized user object
    const user = await NAVI.Guards.requireAuth({ logoSel: '#userLogo' });
    if (!user) return; // redirected

    // 2) Fill identity pills
    document.getElementById('welcomeName').textContent = user.username || '—';
    document.getElementById('pillLevel').textContent   = user.levelName || '—';
    document.getElementById('pillGroup').textContent   = user.groupName || '—';
    document.getElementById('pillId').textContent      = user.userId    || '—';

    // 3) Render dashboard modules
    renderModules(user);

    // 4) Wire interactions
    wireButtons();

    // 5) Optional quick stats for super/admin
    const level = (user.levelName||'').toLowerCase();
    if (level === 'super' || level === 'admin') {
      document.getElementById('quickStats').style.display = 'grid';
      try {
        const res = await NAVI.api.users.list();
        if (res?.ok && Array.isArray(res.users)) {
          document.getElementById('totalUsers').textContent = String(res.users.length);
        }
      } catch(_) {}
    }
  })();

  // ---- helpers ----
  function renderModules(user) {
    const level = (user.levelName||'').toLowerCase();
    const groupIdStr = String(user.groupId||'');
    const groupName  = String(user.groupName||'').toLowerCase();

    const cards = [];
    const add = (html) => cards.push(`<div class="module">${html}</div>`);

    if (level === 'super' || level === 'admin') {
      add(`
        <h3>👥 User Management</h3>
        <p>Create, edit, and manage user accounts and permissions.</p>
        <div class="row">
          <button type="button" class="btn-outline" id="btnCreateUser">Create User</button>
          <button type="button" class="btn-outline" id="btnEditUser">Edit Users</button>
        </div>
      `);

      add(`
        <h3>🏢 Company Management</h3>
        <p>Register and manage company information.</p>
        <div class="row">
          <button type="button" class="btn-outline" id="btnRegisterCompany">Register Company</button>
          <button type="button" class="btn-outline" id="btnListCompany">Companies List</button>
        </div>
      `);

      add(`
        <h3>🚢 Vessel Management</h3>
        <p>Register new vessels and manage existing ones.</p>
        <div class="row">
          <button type="button" class="btn-outline" id="btnRegisterVessel">Register Vessel</button>
          <button type="button" class="btn-outline" id="btnEditVessel">Edit Vessels</button>
          <button type="button" class="btn-outline" id="btnViewVessel">View Vessel</button>
        </div>
      `);

      if (level === 'super') {
        add(`
          <h3>⚙️ System Administration</h3>
          <p>Manage roles, groups, and system settings.</p>
          <div class="row">
            <button type="button" class="btn-outline" id="btnAddLevelGroup">Roles & Groups</button>
            <button type="button" class="btn-outline" id="btnSystemLogs">System Logs</button>
          </div>
        `);
      }

      add(`
        <h3>📊 Reports & Analytics</h3>
        <p>View system reports, activity, and KPIs.</p>
        <div class="row">
          <button type="button" class="btn-outline" id="btnReports">View Reports</button>
          <button type="button" class="btn-outline" id="btnActivity">Activity Log</button>
        </div>
      `);
    } else if (level === 'user') {
      add(`
        <h3>📋 My Profile</h3>
        <p>Your account details (read-only).</p>
        <div class="row">
          <button type="button" class="btn-outline" id="btnMyProfile">View Profile</button>
        </div>
      `);

      add(`
        <h3>🏢 Companies</h3>
        <p>Browse company information.</p>
        <div class="row">
          <button type="button" class="btn-outline" id="btnListCompany">Companies List</button>
        </div>
      `);

      let extra = '';
      if (groupIdStr === '1' || groupName.includes('staff')) {
        extra = `<button type="button" class="btn-outline" id="btnEditVessel">Edit Vessel Info</button>`;
      }

      add(`
        <h3>🚢 My Vessels</h3>
        <p>View and manage vessel information assigned to your account.</p>
        <div class="row">
          <button type="button" class="btn-outline" id="btnViewVessel">View Vessel</button>
          ${extra}
        </div>
      `);
    } else {
      add(`
        <h3>⚠️ Access Limited</h3>
        <p>Your current user level has limited access. You can still view assigned vessels.</p>
        <div class="row">
          <button type="button" class="btn-outline" id="btnViewVessel">View Vessel</button>
          <button type="button" class="btn-outline" id="btnContactAdmin">Contact Support</button>
        </div>
      `);
    }

    document.getElementById('modulesContainer').innerHTML = cards.join('');
  }

  function wireButtons() {
    const go = (page) => {
      // Navigate relative to this dashboard file
      const base = location.pathname.replace(/[^/]+$/, '');
      window.location.href = `${base}${page}.html`;
    };

    const map = {
      'btnCreateUser':      () => go('create_user'),
      'btnEditUser':        () => go('edit_user'),
      'btnRegisterVessel':  () => go('register_vessel'),
      'btnEditVessel':      () => go('edit_vessel'),
      'btnViewVessel':      () => go('view_vessel'),
      'btnRegisterCompany': () => go('register_client'),
      'btnListCompany':     () => go('client_list'),
      'btnAddLevelGroup':   () => alert('Coming soon'),
      'btnSystemLogs':      () => alert('Coming soon'),
      'btnReports':         () => alert('Coming soon'),
      'btnActivity':        () => alert('Coming soon'),
      'btnContactAdmin':    () => alert('Email support@…'),
      'btnMyProfile':       () => go('client_profile'),
      'btnChangePassword':  () => go('change_password'),
      'btnSecurityInfo':    () => alert('Security info page coming soon')
    };

    Object.entries(map).forEach(([id, fn]) => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('click', fn);
    });

    const logoutBtn = document.getElementById('btnLogout');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', () => {
        if (confirm('Are you sure you want to logout?')) {
          NAVI.api.auth.logout().finally(() => {
            const base = location.pathname.replace(/[^/]+$/, '');
            window.location.href = `${base}index.html`;
          });
        }
      });
    }
  }
  </script>
</body>
</html>
