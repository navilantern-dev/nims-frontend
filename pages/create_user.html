<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>NAVI-SIMS – Create User</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Oswald:wght@700&display=swap');
    :root {
      --bg: #F6F7FB; --card: #ffffff; --panel: #F9FAFB; --text: #0F172A; --muted: #64748B;
      --border: #E5E7EB; --ring: #2563EB; --primary: #2563EB; --danger: #EF4444;
      --radius: 18px; --shadow: 0 10px 30px rgba(2, 6, 23, .08);
    }
    @media (prefers-color-scheme: dark) {
      :root { --bg: #0B1220; --card: #0F172A; --panel: #111827; --text: #E5E7EB; --muted: #94A3B8; --border: #1F2937; --primary: #60A5FA; --shadow: 0 10px 30px rgba(0, 0, 0, .45); }
    }
    * { box-sizing: border-box; }
    body { margin: 0; background: var(--bg); color: var(--text); min-height: 100vh; display: flex; align-items: center; justify-content: center; font: 400 16px/1.45 ui-sans-serif, system-ui; }
    .wrap { width: min(96vw, 1100px); }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 26px; box-shadow: var(--shadow); }
    .banner-container { width: 100%; text-align: center; padding: 2rem 1rem; background: #ffffff; border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 1rem; }
    .banner-heading { font-family: "Arial Unicode MS", Arial, sans-serif; font-weight: 700; font-size: clamp(3rem, 12vw, 6rem); letter-spacing: 0.65vw; margin: 0 -1rem 0; }
    .banner-heading .part-one { color: #231F20; }
    .banner-heading .part-two { color: #965A37; }
    .banner-subheading { font-family: 'Montserrat', sans-serif; text-transform: uppercase; color: #231F20; letter-spacing: 5px; margin-top: 0; font-weight: 500; font-size: clamp(0.6rem, 2.5vw, 0.9rem); }
    .title { display: flex; align-items: center; gap: 14px; margin-bottom: 8px; }
    .muted { color: var(--muted); }
    .grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 1024px) { .grid { grid-template-columns: 1fr 1fr; } }
    .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 14px; padding: 16px; }
    .panel h3 { margin: 0 0 10px; font-size: 1.04rem; }
    label { font-size: .9rem; color: var(--muted); display: block; margin: 8px 0 6px; }
    input, select { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 12px; outline: none; background: #fff; height: 44px; }
    @media (prefers-color-scheme: dark) { input, select { background: #0F172A; color: var(--text); } }
    input:focus, select:focus { border-color: var(--ring); box-shadow: 0 0 0 4px color-mix(in oklab, var(--ring) 18%, transparent); }
    .row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
    .btn { background: var(--primary); color: #fff; border: none; border-radius: 12px; padding: 10px 14px; cursor: pointer; }
    .btn.alt { background: #334155; color: #fff; }
    .btn[disabled] { opacity: .6; cursor: not-allowed; }
    .msg { margin-top: 10px; display: none; padding: 10px; border-radius: 10px; }
    .msg.ok { background: #E6FFED; color: #065F46; border: 1px solid #A7F3D0; }
    .msg.err { background: #FEE2E2; color: #991B1B; border: 1px solid #FECACA; }
    .hint { font-size: .8rem; color: var(--muted); }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #EEF2FF; color: #3730A3; font-size: .78rem; border: 1px solid #E0E7FF; }
    .divider { height: 1px; background: var(--border); margin: 10px 0; }
    .req::after { content: " *"; color: var(--danger); }
    .pager-top { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin: -6px 0 10px; }
    .steps { display: flex; gap: 6px; align-items: center; }
    .step-dot { width: 9px; height: 9px; border-radius: 50%; background: #CBD5E1; border: 1px solid #94A3B8; }
    .step-dot.active { background: var(--primary); border-color: var(--primary); }
    #detailsPager .page { display: none; }
    #detailsPager .page.active { display: block; }
    .pager-controls { display: flex; gap: 10px; margin-top: 12px; }
    .pager-controls .btn.soft { background: #E5E7EB; color: #111827; }
    textarea { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 12px; outline: none; background: #fff; min-height: 92px; resize: vertical; }
    @media (prefers-color-scheme: dark) { textarea { background: #0F172A; color: var(--text); } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="banner-container">
      <h1 class="banner-heading"><span class="part-one">NAVI</span><span class="part-two">LANTERN</span></h1>
      <p class="banner-subheading">NAVAL ARCHITECTURE . MARINE SURVEY . MARINE ENGINEERING</p>
    </div>

    <div class="card">
      <div class="title">
        <div>
          <h2 style="margin:0">Create User</h2>
          <div class="muted">Your level: <span id="userLevel">—</span></div>
        </div>
        <button id="btnBack" class="btn alt" type="button" style="margin-left:auto">Back</button>
      </div>

      <div class="grid">
        <div class="panel" id="card1">
          <h3>Create Login Information</h3>
          
          <label class="req" for="username">Username</label>
          <input id="username" type="text" required autocomplete="off">

          <label class="req" for="password">Password</label>
          <input id="password" type="text" required autocomplete="new-password">

          <label class="req" for="level">User Level</label>
          <select id="level" required>
            <option value="">— Select Level —</option>
          </select>
          <div class="hint">USER_ID prefix: <span class="badge">0 → 1xxxx</span> <span class="badge">1 → 2xxxx</span> <span class="badge">3 → 3xxxx</span></div>

          <label class="req" for="group">User Group</label>
          <select id="group" required>
            <option value="">— Select Group —</option>
          </select>

          <div class="row">
            <button id="btnCreate" class="btn" type="button" disabled>Create User</button>
            <button id="btnReset1" class="btn alt" type="button">Reset</button>
          </div>

          <div id="msg1Ok" class="msg ok"></div>
          <div id="msg1Err" class="msg err"></div>

          <div id="createdBlock" style="display:none;margin-top:10px">
            <div class="divider"></div>
            <div class="hint">Generated USER_ID</div>
            <div id="createdUserId" class="badge"></div>
          </div>
        </div>

        <div class="panel" id="card2" style="display:none;">
          <div class="pager-top">
            <h3 id="card2Title" style="margin:0">User Details</h3>
            <div class="steps" id="steps"></div>
          </div>
          <div class="hint">Fill in additional details for USER_ID <span id="hUserId"></span></div>

          <div id="detailsPager"></div>

          <div class="pager-controls">
            <button id="btnPrev" class="btn soft" type="button">← Prev</button>
            <button id="btnNext" class="btn soft" type="button" style="margin-left:auto">Next →</button>
          </div>

          <div class="row">
            <button id="btnSaveDetails" class="btn" type="button">Save Details</button>
            <button id="btnReset2" class="btn alt" type="button">Reset</button>
          </div>

          <div id="msg2Ok" class="msg ok"></div>
          <div id="msg2Err" class="msg err"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="../assets/js/bridge.js"></script>
  <script>
    (async function() {
      const user = await NAVI.Guards.requireAuth();
      if (!user) return;

      document.getElementById('userLevel').textContent = user.levelName || '—';

      const $ = (id) => document.getElementById(id);
      const PAGE_SIZE = 8;
      let currentPage = 0, totalPages = 0;
      let CREATED_USER_ID = null, SELECTED_GROUP_ID = null, DETAIL_SCHEMA = null;

      function setMsg(which, ok, text) {
        const okBox = $(`msg${which}Ok`), errBox = $(`msg${which}Err`);
        if (okBox) okBox.style.display = 'none';
        if (errBox) errBox.style.display = 'none';
        if (ok && okBox) { okBox.textContent = text; okBox.style.display = 'block'; }
        if (!ok && errBox) { errBox.textContent = text; errBox.style.display = 'block'; }
      }

      function enableCreateIfValid() {
        const u = ($('username')?.value || '').trim();
        const p = ($('password')?.value || '').trim();
        const l = ($('level')?.value || '').trim();
        const g = ($('group')?.value || '').trim();
        const valid = !!(u && p && l && g);
        $('btnCreate').disabled = !valid;
        return valid;
      }

      async function fileToBase64(file) {
        return new Promise((resolve, reject) => {
          const fr = new FileReader();
          fr.onload = () => resolve(fr.result);
          fr.onerror = reject;
          fr.readAsDataURL(file);
        });
      }

      function renderSteps(container, count) {
        container.innerHTML = '';
        for (let i = 0; i < count; i++) {
          const dot = document.createElement('div');
          dot.className = 'step-dot' + (i === currentPage ? ' active' : '');
          dot.dataset.index = i;
          dot.addEventListener('click', () => goToPage(i));
          container.appendChild(dot);
        }
      }

      function goToPage(n) {
        const pages = document.querySelectorAll('#detailsPager .page');
        if (!pages.length) return;
        currentPage = Math.max(0, Math.min(n, pages.length - 1));
        pages.forEach((p, i) => p.classList.toggle('active', i === currentPage));
        $('btnPrev').disabled = (currentPage === 0);
        $('btnNext').disabled = (currentPage === pages.length - 1);
        renderSteps($('steps'), pages.length);
      }

      function buildDetailsForm(schema) {
        const pager = $('detailsPager');
        const cols = schema.columns || [];
        const fileCols = new Set(schema.fileColumns || []);
        const pieces = cols.map(col => {
          const label = col.replace(/_/g, ' ');
          if (fileCols.has(col)) {
            return `<label data-col="${col}">${label}</label><input type="file" data-col="${col}" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.jpg,.jpeg,.png,.gif,.webp,.heic,image/*">`;
          }
          const isTextArea = /ADDRESS/i.test(col);
          if (isTextArea) return `<label data-col="${col}">${label}</label><textarea data-col="${col}"></textarea>`;
          const type = /EMAIL/i.test(col) ? 'email' : (/PHONE|CONTACT/i.test(col) ? 'tel' : 'text');
          return `<label data-col="${col}">${label}</label><input type="${type}" data-col="${col}">`;
        });

        pager.innerHTML = '';
        totalPages = Math.ceil(pieces.length / PAGE_SIZE) || 1;
        for (let i = 0; i < totalPages; i++) {
          const page = document.createElement('div');
          page.className = 'page';
          page.dataset.page = i;
          page.innerHTML = pieces.slice(i * PAGE_SIZE, (i + 1) * PAGE_SIZE).join('');
          pager.appendChild(page);
        }
        currentPage = 0;
        goToPage(0);
      }

      // Load levels and groups
      async function loadOptions() {
        try {
          const [levelsRes, groupsRes] = await Promise.all([
            NAVI.API.meta.levels(),
            NAVI.API.meta.groups()
          ]);

          if (levelsRes.ok) {
            $('level').innerHTML = '<option value="">— Select Level —</option>' +
              levelsRes.levels.map(l => `<option value="${l.id}">${l.id} — ${l.name}</option>`).join('');
          }

          if (groupsRes.ok) {
            $('group').innerHTML = '<option value="">— Select Group —</option>' +
              groupsRes.groups.map(g => `<option value="${g.id}">${g.id} — ${g.name}</option>`).join('');
          }
        } catch (err) {
          setMsg(1, false, err.message || 'Failed to load options');
        }
      }

      loadOptions();

      ['username', 'password', 'level', 'group'].forEach(id => {
        const el = $(id);
        if (el) ['input', 'change'].forEach(ev => el.addEventListener(ev, enableCreateIfValid));
      });

      $('group').addEventListener('change', (e) => {
        SELECTED_GROUP_ID = e.target.value;
      });

      $('btnCreate').addEventListener('click', async () => {
        if (!enableCreateIfValid()) return;
        setMsg(1, true, ''); setMsg(1, false, '');
        
        const payload = {
          username: $('username').value.trim(),
          password: $('password').value.trim(),
          levelId: $('level').value.trim(),
          groupId: $('group').value.trim()
        };

        try {
          const res = await NAVI.API.users.create(payload);
          if (!res?.ok) { setMsg(1, false, res?.msg || 'Failed to create user.'); return; }
          
          CREATED_USER_ID = res.userId;
          SELECTED_GROUP_ID = payload.groupId;
          $('createdUserId').textContent = CREATED_USER_ID;
          $('createdBlock').style.display = 'inline-block';
          setMsg(1, true, 'User created successfully!');
          $('hUserId').textContent = CREATED_USER_ID;
          
          // Load detail schema (placeholder - you'll need to implement this in your backend)
          $('card2').style.display = 'block';
          // Mock schema for demonstration
          DETAIL_SCHEMA = { ok: true, columns: ['FULL_NAME', 'ADDRESS', 'PHONE'], fileColumns: [] };
          buildDetailsForm(DETAIL_SCHEMA);
        } catch (err) {
          setMsg(1, false, err?.message || 'Unexpected error.');
        }
      });

      $('btnSaveDetails').addEventListener('click', async () => {
        setMsg(2, true, ''); setMsg(2, false, '');
        if (!CREATED_USER_ID || !SELECTED_GROUP_ID || !DETAIL_SCHEMA) {
          setMsg(2, false, 'Create a user first.'); return;
        }

        const fileCols = new Set(DETAIL_SCHEMA.fileColumns || []);
        const values = {}, files = {};
        const controls = document.querySelectorAll('#detailsPager [data-col]');
        
        try {
          for (const el of controls) {
            const col = el.getAttribute('data-col');
            if (!col) continue;
            if (fileCols.has(col)) {
              const f = el.files && el.files[0];
              if (f) {
                const b64 = await fileToBase64(f);
                files[col] = { name: f.name, mime: f.type, dataBase64: b64 };
              }
            } else {
              values[col] = (el.value || '').trim();
            }
          }

          const res = await NAVI.API.users.saveDetails({ userId: CREATED_USER_ID, groupId: SELECTED_GROUP_ID, values, files });
          if (!res?.ok) { setMsg(2, false, res?.msg || 'Failed to save details.'); return; }
          setMsg(2, true, res.msg || 'Details saved successfully!');
        } catch (err) {
          setMsg(2, false, 'Error: ' + err.message);
        }
      });

      $('btnReset1').addEventListener('click', () => {
        ['username', 'password', 'level', 'group'].forEach(id => { const el = $(id); if (el) el.value = ''; });
        setMsg(1, true, ''); setMsg(1, false, '');
        $('btnCreate').disabled = true;
        $('card2').style.display = 'none';
        $('createdBlock').style.display = 'none';
        CREATED_USER_ID = null; SELECTED_GROUP_ID = null; DETAIL_SCHEMA = null;
      });

      $('btnReset2').addEventListener('click', () => {
        if (DETAIL_SCHEMA) buildDetailsForm(DETAIL_SCHEMA);
        setMsg(2, true, ''); setMsg(2, false, '');
      });

      $('btnPrev').addEventListener('click', () => goToPage(currentPage - 1));
      $('btnNext').addEventListener('click', () => goToPage(currentPage + 1));
      $('btnBack').addEventListener('click', () => window.location.href = './dashboard.html');
    })();
  </script>
</body>
</html>