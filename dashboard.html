<!doctype html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Cache-Control" content="no-store, max-age=0">
  <title>NAVI-SIMS ‚Äî Dashboard</title>
  <style>
/* ===== NAVI-SIMS Design System (enhanced dashboard) ===== */
:root{
  --bg:#F6F7FB; --card:#ffffff; --panel:#F9FAFB; --text:#0F172A;
  --muted:#64748B; --border:#E5E7EB; --ring:#2563EB; --primary:#2563EB; --success:#10B981; --warning:#F59E0B;
  --radius:18px; --shadow:0 10px 30px rgba(2,6,23,.08);
}
@media (prefers-color-scheme: dark){
  :root{ --bg:#0B1220; --card:#0F172A; --panel:#111827; --text:#E5E7EB; --muted:#94A3B8; --border:#1F2937; --primary:#60A5FA; --shadow:0 10px 30px rgba(0,0,0,.45) }
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);min-height:100vh;display:flex;align-items:center;justify-content:center;font:400 16px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;}
.wrap{width:min(96vw,1200px)}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:28px;box-shadow:var(--shadow)}
.top{display:flex;align-items:center;gap:18px;margin-bottom:12px}
.logo{width:52px;height:52px;border-radius:999px;object-fit:cover;background:#fff;box-shadow:0 0 0 2px var(--border)}
h2{margin:0 0 4px 0;font-size:1.5rem}
.user-info{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.pill{display:inline-block;margin-right:8px;padding:6px 12px;border:1px solid var(--border);border-radius:999px;font-size:.82rem;color:var(--muted);background:var(--panel)}
.security-status{display:flex;gap:8px;align-items:center;margin-top:8px}
.status-indicator{width:8px;height:8px;border-radius:50%}
.status-indicator.secure{background:var(--success)}
.status-indicator.warning{background:var(--warning)}
.security-text{font-size:.8rem;color:var(--muted)}

.modules{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:18px;margin-top:20px}
.module{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:20px;transition:all .2s ease}
.module:hover{box-shadow:0 8px 25px rgba(2,6,23,.12);transform:translateY(-2px)}
.module h3{margin:0 0 10px;font-size:1.08rem;color:var(--text)}
.module p{margin:0 0 16px;font-size:.9rem;color:var(--muted);line-height:1.5}
.row{display:flex;gap:12px;flex-wrap:wrap}
.btn-outline{
  background:transparent;border:1px solid var(--primary);color:var(--primary);
  padding:10px 14px;border-radius:12px;cursor:pointer;transition:all .15s ease;
  text-decoration:none;display:inline-block;font-size:.9rem;font-weight:500;
}
.btn-outline:hover{background:color-mix(in oklab, var(--primary) 8%, transparent);transform:translateY(-1px)}

.user-actions{display:flex;gap:12px;margin-top:20px;padding-top:16px;border-top:1px solid var(--border)}
.btn{background:var(--primary);color:#fff;border:none;border-radius:12px;padding:10px 16px;cursor:pointer;font-weight:600;transition:all .15s ease}
.btn:hover{filter:brightness(1.05);transform:translateY(-1px)}
.btn.secondary{background:#6B7280}
.btn.danger{background:#EF4444}

.quick-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin:16px 0}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center}
.stat-number{font-size:1.8rem;font-weight:700;color:var(--primary)}
.stat-label{font-size:.85rem;color:var(--muted);margin-top:4px}

@media (max-width: 768px) {
  .top{flex-direction:column;align-items:flex-start;gap:12px}
  .user-actions{flex-direction:column}
  .modules{grid-template-columns:1fr}
}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <img class="logo" src="<?!= logoUrl ?>" alt="Logo" onerror="this.style.display='none'">
        <div style="flex:1">
          <h2>Welcome, <?= username ?></h2>
          <div class="user-info">
            <div class="pill">Level: <?= userLevel || 'Unknown' ?></div>
            <div class="pill">Group: <?= userGroup || 'Unknown' ?></div>
            <div class="pill">ID: <?= userId || 'Unknown' ?></div>
          </div>
          <div class="security-status">
            <div class="status-indicator secure" id="securityIndicator"></div>
            <div class="security-text" id="securityText">Secure session active</div>
          </div>
        </div>
      </div>

      <div class="quick-stats" id="quickStats" style="display:none">
        <div class="stat-card">
          <div class="stat-number" id="totalUsers">-</div>
          <div class="stat-label">Total Users</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalVessels">-</div>
          <div class="stat-label">Registered Vessels</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="recentActivity">-</div>
          <div class="stat-label">Recent Activities</div>
        </div>
      </div>

      <? var lvl = (userLevel || '').toString().toLowerCase(); ?>
      <? 
        var __UGID   = (typeof userGroupId !== 'undefined' && userGroupId != null) ? String(userGroupId) : '';
        var __UGNAME = (typeof userGroup   !== 'undefined' && userGroup   != null) ? String(userGroup)   : '';
      ?>

      <? if (lvl === 'super' || lvl === 'admin') { ?>
        <div class="modules">
          <div class="module">
            <h3>üë• User Management</h3>
            <p>Create, edit, and manage user accounts. Control access levels and permissions.</p>
            <div class="row">
              <button class="btn-outline" data-goto="create_user">Create User</button>
              <button class="btn-outline" data-goto="edit_user">Edit Users</button>
            </div>
          </div>

          <div class="module">
            <h3>üè¢ Company Management</h3>
            <p>Register and manage company information and business details.</p>
            <div class="row">
              <button class="btn-outline" data-goto="register_client">Register Company</button>
              <button class="btn-outline" data-goto="client_list">Companies List</button>
            </div>
          </div>

          <div class="module">
            <h3>üö¢ Vessel Management</h3>
            <p>Register new vessels and manage existing vessel information and inventories.</p>
            <div class="row">
              <button class="btn-outline" data-goto="register_vessel"></button>Register Vessel</button>
              <button class="btn-outline" data-goto="edit_vessel">Edit Vessels</button>
              <button class="btn-outline" data-goto="view_vessel">View Vessel</button>
            </div>
          </div>

          <? if (lvl === 'super') { ?>
            <div class="module">
              <h3>‚öôÔ∏è System Administration</h3>
              <p>Manage user roles, groups, and system-wide configurations.</p>
              <div class="row">
                <button type="button" class="btn-outline" id="btnAddLevelGroup">Roles & Groups</button>
                <button type="button" class="btn-outline" id="btnSystemLogs">System Logs</button>
              </div>
            </div>
          <? } ?>

          <div class="module">
            <h3>üìä Reports & Analytics</h3>
            <p>View system reports, user activity, and vessel statistics.</p>
            <div class="row">
              <button type="button" class="btn-outline" id="btnReports">View Reports</button>
              <button type="button" class="btn-outline" id="btnActivity">Activity Log</button>
            </div>
          </div>
        </div>

      <? } else if (lvl === 'user') { ?>
        <div class="modules" style="grid-template-columns:1fr">
          <div class="module">
            <h3>üìã My Profile</h3>
            <p>Your account details (read-only).</p>
            <div id="myProfileView" style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px"></div>
          </div>
          <div class="module">
              <h3>üè¢ Companies Details</h3>
              <p>Company information and business details.</p>
              <div class="row">
                <button class="btn-outline" data-goto="client_list">Companies List</button>  <!-- THIS VIEW IS FOR USER (STAFF/ENGINEER) -->
              </div>
          </div>
          <div class="module">
            <h3>üö¢ My Vessels</h3>
            <p>View and manage vessel information assigned to your account.</p>
            <div class="row">
              <button class="btn-outline" data-goto="view_vessel">View Vessel</button>
              <? if (__UGID === '1' || /staff/i.test(__UGNAME)) { ?>
                <button class="btn-outline" data-goto="edit_vessel">Edit Vessel Info</button>
              <? } ?>
            </div>
          </div>
        </div>

      <? } else { ?>
        <div class="modules">
          <div class="module">
            <h3>‚ö†Ô∏è Access Limited</h3>
            <p>Your current user level has limited access. You can still view vessels assigned to you.</p>
            <div class="row">
              <button class="btn-outline" data-goto="view_vessel">View Vessel</button>
              <button type="button" class="btn-outline" id="btnContactAdmin">Contact Support</button>
            </div>
          </div>
        </div>
      <? } ?>

      <div class="user-actions">
        <button class="btn secondary" data-goto="change_password">Change Password</button>
        <button id="btnSecurity" class="btn secondary">Security Info</button>
        <div style="flex:1"></div>
        <button id="btnLogout" class="btn danger">Secure Logout</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const token    = "<?= token ?>";
      const appUrl   = "<?= appUrl ?>";
      const userLevel = "<?= userLevel ?>";
      const userGroupId = "<?= userGroupId ?>";

      const userGroupName = "<?= userGroup ?>"; // display name
      // expose for renderProfile (which is outside the IIFE)
      window.__UL  = userLevel;       // e.g. "user"
      window.__UGN = userGroupName;   // e.g. "client"

      // Navigation helper
      function navigate(page) {
        window.top.location.href = `${appUrl}?page=${page}&token=${encodeURIComponent(token)}`;
      }

      // Logout with confirmation
      document.getElementById('btnLogout').addEventListener('click', () => {
        if (confirm('Are you sure you want to logout?')) {
          google.script.run
            .withSuccessHandler(() => window.top.location.href = `${appUrl}?page=login`)
            .withFailureHandler(() => window.top.location.href = `${appUrl}?page=login`)
            .logout(token);
        }
      });

      // Button event listeners
      const buttons = {
        'btnCreateUser':      () => navigate('create_user'),
        'btnEditUser':        () => navigate('edit_user'),
        'btnRegisterVessel':  () => navigate('register_vessel'),
        'btnEditVessel':      () => navigate('edit_vessel'),
        'btnViewVessel':      () => navigate('view_vessel'),  // ‚úÖ point to the new page
        'btnChangePassword':  () => navigate('change_password'),
        'btnEditProfile':     () => navigate('edit_user'),     // Edit own profile (reuse)
        'btnRegisterCompany': () => navigate('register_client'),
        'btnEditCompany':     () => navigate('client_profile'),
        'btnListCompany':     () => navigate('client_list'),
      };

      Object.entries(buttons).forEach(([id, handler]) => {
        const btn = document.getElementById(id);
        if (btn) btn.addEventListener('click', handler);
      });

      // Placeholder buttons
      [
        'btnAddLevelGroup','btnSystemLogs',
        'btnReports','btnActivity','btnMyActivity','btnContactAdmin'
      ].forEach(id=>{
        const btn = document.getElementById(id);
        if (btn) btn.addEventListener('click', ()=> alert('This feature is coming soon!'));
      });

      // Security info
      const btnSecurity = document.getElementById('btnSecurity');
      if (btnSecurity) {
        btnSecurity.addEventListener('click', () => {
          google.script.run
            .withSuccessHandler((res) => {
              if (res?.ok) {
                const info = res.security;
                const message = `Security Information:
                
Last Login: ${info.lastLogin}
Failed Login Attempts: ${info.failedAttempts}
Secure Password: ${info.hasSecurePassword ? 'Yes' : 'No (Please update)'}
Session Expires: ${new Date(info.sessionExpiry).toLocaleString()}

Your account is protected with advanced security measures including password encryption, session management, and activity logging.`;
                alert(message);
              } else {
                alert('Unable to retrieve security information.');
              }
            })
            .withFailureHandler(() => alert('Unable to retrieve security information.'))
            .getSecurityInfo(token);
        });
      }

      // Security indicator (placeholder timing)
      function updateSecurityStatus() {
        const indicator = document.getElementById('securityIndicator');
        const text = document.getElementById('securityText');
        const sessionAge = 0; // Placeholder
        if (sessionAge > 3000000) { // 50 minutes
          indicator.className = 'status-indicator warning';
          text.textContent = 'Session expiring soon';
        } else {
          indicator.className = 'status-indicator secure';
          text.textContent = 'Secure session active';
        }
      }

      // Quick stats for admins
      if (userLevel === 'super' || userLevel === 'admin') {
        const statsContainer = document.getElementById('quickStats');
        if (statsContainer) {
          statsContainer.style.display = 'grid';
          google.script.run
            .withSuccessHandler((res) => {
              if (res?.ok) {
                document.getElementById('totalUsers').textContent = res.users?.length || '0';
              }
            })
            .withFailureHandler(() => { document.getElementById('totalUsers').textContent = 'N/A'; })
            .getEditableUserList(token);
        }
      }

      // Init
      updateSecurityStatus();
      // Load my profile (Client_Info if USER_GROUP=0, Staff_Info if USER_GROUP=1)
      google.script.run
      .withSuccessHandler(renderProfile)
      .withFailureHandler(() => {
        const box = document.getElementById('myProfileView');
        if (box) box.textContent = 'Unable to load profile.';
      })
      .getMyProfile(token, "<?= userId ?>", "<?= username ?>");  // ‚Üê pass hints

      setInterval(updateSecurityStatus, 60000);

      // Session timeout prompt (50 mins)
      setTimeout(() => {
        if (confirm('Your session will expire soon. Would you like to extend it?')) {
          google.script.run.withSuccessHandler(() => {}).getUserSessionInfo(token);
        }
      }, 50 * 60 * 1000);
    })();

    // escape + render
    function _esc(s){ return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    function _esc(s){ return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function renderProfile(res){
      const box = document.getElementById('myProfileView');
      if (!box) return;
      
      console.log('Profile response:', res); // Debug log
      
      if (!res?.ok) { 
        // Show debug information if available
        if (res?.debug) {
          console.log('Debug info:', res.debug);
          box.innerHTML = `
            <div style="color: var(--muted); font-size: 0.9rem;">
              <p><strong>Debug Information:</strong></p>
              <p>User ID: ${res.debug.userId || 'N/A'}</p>
              <p>Username: ${res.debug.username || 'N/A'}</p>
              <p>Group: ${res.debug.group || 'N/A'} (ID: ${res.debug.groupId || 'N/A'})</p>
              <p>Sheet: ${res.debug.sheetName || 'N/A'}</p>
              <p>Is Staff: ${res.debug.isStaff ? 'Yes' : 'No'}</p>
              <p>Search Method: ${res.debug.searchMethod || 'None'}</p>
              <p>Available Headers: ${res.debug.availableHeaders ? res.debug.availableHeaders.join(', ') : 'None'}</p>
              <p>Total Rows: ${res.debug.totalRows || 0}</p>
              <p><em>Error: ${res.msg || 'Unknown error'}</em></p>
            </div>
          `;
        } else {
          box.textContent = res.msg || 'No profile found.'; 
        }
        return; 
      }

      if (!res.data) { 
        box.textContent = 'No profile data available.'; 
        return; 
      }

      const keys = Array.isArray(res.order) && res.order.length ? res.order : Object.keys(res.data);
      const rows = keys.map(k => {
        const value = res.data[k];
        const displayValue = (value === null || value === undefined || value === '') ? 
                            '<em style="color: var(--muted);">Not specified</em>' : 
                            _esc(value);
        
        return `<tr>
          <th style="text-align:left;padding:8px 10px;color:var(--muted);min-width:120px">${_esc(k.replace(/_/g, ' '))}</th>
          <td style="padding:8px 10px">${displayValue}</td>
        </tr>`;
      }).join('');

      box.innerHTML = `<table style="width:100%;border-collapse:collapse">${rows}</table>`;
      
      // Show debug info in console if available
      if (res.debug) {
        console.log('Profile loaded successfully:', res.debug);
      }
    }
  </script>
  <!-- <script src="js/api.js"></script>
  <script src="js/nav.js"></script>
  <script>
    // Requires nav.js (for goTo/getToken)
    document.addEventListener('click', (e) => {
      const el = e.target.closest('[data-goto]');
      if (!el) return;
      e.preventDefault();
      const page = el.getAttribute('data-goto');
      goTo(page);
    });
  </script>
  <script src="js/shim.google.run.js"></script>
  <script>
    // Redirects to login.html if no valid token is present
    const token = requireAuth();

    // Optional: standard Back button support if your page has #btnBack
    document.getElementById('btnBack')?.addEventListener('click', () => goTo('dashboard'));
  </script> -->
</body>
</html>
