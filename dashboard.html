<!doctype html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Cache-Control" content="no-store, max-age=0">
  <title>NAVI-SIMS ‚Äî Dashboard</title>
  <style>
/* ===== NAVI-SIMS Design System (enhanced dashboard) ===== */
:root{
  --bg:#F6F7FB; --card:#ffffff; --panel:#F9FAFB; --text:#0F172A;
  --muted:#64748B; --border:#E5E7EB; --ring:#2563EB; --primary:#2563EB; --success:#10B981; --warning:#F59E0B;
  --radius:18px; --shadow:0 10px 30px rgba(2,6,23,.08);
}
@media (prefers-color-scheme: dark){
  :root{ --bg:#0B1220; --card:#0F172A; --panel:#111827; --text:#E5E7EB; --muted:#94A3B8; --border:#1F2937; --primary:#60A5FA; --shadow:0 10px 30px rgba(0,0,0,.45) }
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);min-height:100vh;display:flex;align-items:center;justify-content:center;font:400 16px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;}
.wrap{width:min(96vw,1200px)}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:28px;box-shadow:var(--shadow)}
.top{display:flex;align-items:center;gap:18px;margin-bottom:12px}
.logo{width:52px;height:52px;border-radius:999px;object-fit:cover;background:#fff;box-shadow:0 0 0 2px var(--border)}
h2{margin:0 0 4px 0;font-size:1.5rem}
.user-info{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.pill{display:inline-block;margin-right:8px;padding:6px 12px;border:1px solid var(--border);border-radius:999px;font-size:.82rem;color:var(--muted);background:var(--panel)}
.security-status{display:flex;gap:8px;align-items:center;margin-top:8px}
.status-indicator{width:8px;height:8px;border-radius:50%}
.status-indicator.secure{background:var(--success)}
.status-indicator.warning{background:var(--warning)}
.security-text{font-size:.8rem;color:var(--muted)}

.modules{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:18px;margin-top:20px}
.module{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:20px;transition:all .2s ease}
.module:hover{box-shadow:0 8px 25px rgba(2,6,23,.12);transform:translateY(-2px)}
.module h3{margin:0 0 10px;font-size:1.08rem;color:var(--text)}
.module p{margin:0 0 16px;font-size:.9rem;color:var(--muted);line-height:1.5}
.row{display:flex;gap:12px;flex-wrap:wrap}
.btn-outline{
  background:transparent;border:1px solid var(--primary);color:var(--primary);
  padding:10px 14px;border-radius:12px;cursor:pointer;transition:all .15s ease;
  text-decoration:none;display:inline-block;font-size:.9rem;font-weight:500;
}
.btn-outline:hover{background:color-mix(in oklab, var(--primary) 8%, transparent);transform:translateY(-1px)}

.user-actions{display:flex;gap:12px;margin-top:20px;padding-top:16px;border-top:1px solid var(--border)}
.btn{background:var(--primary);color:#fff;border:none;border-radius:12px;padding:10px 16px;cursor:pointer;font-weight:600;transition:all .15s ease}
.btn:hover{filter:brightness(1.05);transform:translateY(-1px)}
.btn.secondary{background:#6B7280}
.btn.danger{background:#EF4444}

.quick-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin:16px 0}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center}
.stat-number{font-size:1.8rem;font-weight:700;color:var(--primary)}
.stat-label{font-size:.85rem;color:var(--muted);margin-top:4px}

@media (max-width: 768px) {
  .top{flex-direction:column;align-items:flex-start;gap:12px}
  .user-actions{flex-direction:column}
  .modules{grid-template-columns:1fr}
}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <img class="logo" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='52' height='52'%3E%3Ccircle fill='%232563EB' cx='26' cy='26' r='26'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='white' font-family='Arial' font-size='20' font-weight='bold'%3EN%3C/text%3E%3C/svg%3E" alt="Logo">
        <div style="flex:1">
          <h2 id="welcomeText">Welcome</h2>
          <div class="user-info">
            <div class="pill" id="userLevel">Level: Loading...</div>
            <div class="pill" id="userGroup">Group: Loading...</div>
            <div class="pill" id="userId">ID: Loading...</div>
          </div>
          <div class="security-status">
            <div class="status-indicator secure" id="securityIndicator"></div>
            <div class="security-text" id="securityText">Secure session active</div>
          </div>
        </div>
      </div>

      <div class="quick-stats" id="quickStats" style="display:none">
        <div class="stat-card">
          <div class="stat-number" id="totalUsers">-</div>
          <div class="stat-label">Total Users</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalVessels">-</div>
          <div class="stat-label">Registered Vessels</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="recentActivity">-</div>
          <div class="stat-label">Recent Activities</div>
        </div>
      </div>

      <div id="modulesContainer" class="modules">
        <!-- Modules will be injected here based on user level -->
      </div>

      <div class="user-actions">
        <button id="btnChangePassword" class="btn secondary">Change Password</button>
        <button id="btnSecurity" class="btn secondary" style="display:none">Security Info</button>
        <div style="flex:1"></div>
        <button id="btnLogout" class="btn danger">Secure Logout</button>
      </div>
    </div>
  </div>

  <script src="js/api.js"></script>
  <script>
    (function(){
      // Get token from URL
      const params = new URLSearchParams(window.location.search);
      const token = params.get('token') || '';

      if (!token) {
        window.location.href = 'login.html?err=' + encodeURIComponent('Session expired. Please login again.');
        return;
      }

      // Store in localStorage for easy access
      localStorage.setItem('navi_token', token);

      let userInfo = null;

      // Navigation helper for GitHub Pages
      function navigate(page) {
        window.location.href = `${page}.html?token=${encodeURIComponent(token)}`;
      }

      // Load user session info
      async function loadUserInfo() {
        try {
          const res = await API.getUserSessionInfo(token);
          
          if (!res || !res.ok) {
            window.location.href = 'login.html?err=' + encodeURIComponent('Session expired. Please login again.');
            return;
          }

          userInfo = res.user;
          
          // Update UI
          document.getElementById('welcomeText').textContent = `Welcome, ${userInfo.username || 'User'}`;
          document.getElementById('userLevel').textContent = `Level: ${userInfo.levelName || 'Unknown'}`;
          document.getElementById('userGroup').textContent = `Group: ${userInfo.groupName || 'Unknown'}`;
          document.getElementById('userId').textContent = `ID: ${userInfo.userId || 'Unknown'}`;

          // Render appropriate modules based on level
          renderModules(userInfo.levelName, userInfo.groupId, userInfo.groupName);

        } catch (err) {
          console.error('Failed to load user info:', err);
          alert('Failed to load session. Please login again.');
          window.location.href = 'login.html';
        }
      }

      function renderModules(levelName, groupId, groupName) {
        const container = document.getElementById('modulesContainer');
        const lvl = (levelName || '').toLowerCase();

        if (lvl === 'super' || lvl === 'admin') {
          container.innerHTML = `
            <div class="module">
              <h3>üë• User Management</h3>
              <p>Create, edit, and manage user accounts. Control access levels and permissions.</p>
              <div class="row">
                <button type="button" class="btn-outline" onclick="navigate('create_user')">Create User</button>
                <button type="button" class="btn-outline" onclick="navigate('edit_user')">Edit Users</button>
              </div>
            </div>

            <div class="module">
              <h3>üè¢ Company Management</h3>
              <p>Register and manage company information and business details.</p>
              <div class="row">
                <button type="button" class="btn-outline" onclick="navigate('register_client')">Register Company</button>
                <button type="button" class="btn-outline" onclick="navigate('client_list')">Companies List</button>
              </div>
            </div>

            <div class="module">
              <h3>üö¢ Vessel Management</h3>
              <p>Register new vessels and manage existing vessel information and inventories.</p>
              <div class="row">
                <button type="button" class="btn-outline" onclick="navigate('register_vessel')">Register Vessel</button>
                <button type="button" class="btn-outline" onclick="navigate('edit_vessel')">Edit Vessels</button>
                <button type="button" class="btn-outline" onclick="navigate('view_vessel')">View Vessel</button>
              </div>
            </div>

            ${lvl === 'super' ? `
            <div class="module">
              <h3>‚öôÔ∏è System Administration</h3>
              <p>Manage user roles, groups, and system-wide configurations.</p>
              <div class="row">
                <button type="button" class="btn-outline" onclick="alert('Coming soon!')">Roles & Groups</button>
                <button type="button" class="btn-outline" onclick="alert('Coming soon!')">System Logs</button>
              </div>
            </div>` : ''}

            <div class="module">
              <h3>üìä Reports & Analytics</h3>
              <p>View system reports, user activity, and vessel statistics.</p>
              <div class="row">
                <button type="button" class="btn-outline" onclick="alert('Coming soon!')">View Reports</button>
                <button type="button" class="btn-outline" onclick="alert('Coming soon!')">Activity Log</button>
              </div>
            </div>
          `;
        } else if (lvl === 'user') {
          const isStaff = groupId === '1' || /staff/i.test(groupName);
          container.innerHTML = `
            <div class="module">
              <h3>üìã My Profile</h3>
              <p>Your account details (read-only).</p>
              <div id="myProfileView" style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px">Loading...</div>
            </div>
            <div class="module">
              <h3>üè¢ Companies Details</h3>
              <p>Company information and business details.</p>
              <div class="row">
                <button type="button" class="btn-outline" onclick="navigate('client_list')">Companies List</button>
              </div>
            </div>
            <div class="module">
              <h3>üö¢ My Vessels</h3>
              <p>View and manage vessel information assigned to your account.</p>
              <div class="row">
                <button type="button" class="btn-outline" onclick="navigate('view_vessel')">View Vessel</button>
                ${isStaff ? `<button type="button" class="btn-outline" onclick="navigate('edit_vessel')">Edit Vessel Info</button>` : ''}
              </div>
            </div>
          `;
          
          // Load profile
          loadProfile();
        } else {
          container.innerHTML = `
            <div class="module">
              <h3>‚ö†Ô∏è Access Limited</h3>
              <p>Your current user level has limited access. You can still view vessels assigned to you.</p>
              <div class="row">
                <button type="button" class="btn-outline" onclick="navigate('view_vessel')">View Vessel</button>
                <button type="button" class="btn-outline" onclick="alert('Please contact your administrator for support.')">Contact Support</button>
              </div>
            </div>
          `;
        }

        // Make navigate function available globally for inline onclick
        window.navigate = navigate;
      }

      async function loadProfile() {
        try {
          const res = await API.getMyProfile(token, userInfo.userId, userInfo.username);
          const box = document.getElementById('myProfileView');
          if (!box) return;
          
          if (!res || !res.ok || !res.data) {
            box.textContent = res?.msg || 'No profile data available.';
            return;
          }

          const keys = Array.isArray(res.order) && res.order.length ? res.order : Object.keys(res.data);
          const rows = keys.map(k => {
            const value = res.data[k];
            const displayValue = (value === null || value === undefined || value === '') ? 
                                '<em style="color: var(--muted);">Not specified</em>' : 
                                escapeHtml(value);
            
            return `<tr>
              <th style="text-align:left;padding:8px 10px;color:var(--muted);min-width:120px">${escapeHtml(k.replace(/_/g, ' '))}</th>
              <td style="padding:8px 10px">${displayValue}</td>
            </tr>`;
          }).join('');

          box.innerHTML = `<table style="width:100%;border-collapse:collapse">${rows}</table>`;
        } catch (err) {
          console.error('Failed to load profile:', err);
          const box = document.getElementById('myProfileView');
          if (box) box.textContent = 'Unable to load profile.';
        }
      }

      function escapeHtml(s) {
        return String(s ?? '').replace(/[&<>"']/g, m => ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        }[m]));
      }

      // Logout
      document.getElementById('btnLogout').addEventListener('click', async () => {
        if (!confirm('Are you sure you want to logout?')) return;
        
        try {
          await API.logout(token);
        } catch (err) {
          console.error('Logout error:', err);
        }
        
        localStorage.removeItem('navi_token');
        window.location.href = 'login.html';
      });

      // Change password
      document.getElementById('btnChangePassword').addEventListener('click', () => {
        navigate('change_password');
      });

      // Init
      loadUserInfo();
      
      setInterval(() => {
        const indicator = document.getElementById('securityIndicator');
        const text = document.getElementById('securityText');
        // You can add actual session checking here
        indicator.className = 'status-indicator secure';
        text.textContent = 'Secure session active';
      }, 60000);
    })();
  </script>
</body>
</html>