<!doctype html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Cache-Control" content="no-store, max-age=0">
  <title>NAVI-SIMS — View Vessel</title>
  <style>
  :root{
    --bg:#F6F7FB; --card:#ffffff; --panel:#F9FAFB; --text:#0F172A; --muted:#64748B;
    --border:#E5E7EB; --ring:#2563EB; --primary:#2563EB; --danger:#EF4444; --ok:#16A34A; --warn:#D97706;
    --radius:18px; --shadow:0 10px 30px rgba(2,6,23,.08);
  }
  @media (prefers-color-scheme: dark){
    :root{ --bg:#0B1220; --card:#0F172A; --panel:#111827; --text:#E5E7EB; --muted:#9AA4B2; --border:#1F2937; --shadow:0 10px 30px rgba(0,0,0,.5); }
  }
  body{ margin:0; font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; color:var(--text); background:var(--bg); }
  .wrap{ max-width:1100px; margin:24px auto; padding:0 16px; }
  .h1{ font-size:22px; font-weight:700; margin:6px 0 16px; }
  .cards{ display:grid; grid-template-columns:1fr; gap:16px; }
  .card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; }
  .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
  .field{ display:flex; flex-direction:column; gap:6px; min-width:220px; }
  label{ font-weight:600; color:var(--muted); }
  select, input[type="text"], button{
    padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:var(--panel); color:var(--text);
  }
  .btn{ background:var(--primary); color:#fff; border:none; cursor:pointer; }
  .btn.alt{ background:transparent; border:1px solid var(--border); color:var(--text); }
  .btn.small{ padding:8px 10px; border-radius:8px; font-size:13px; }
  .list{ border:1px solid var(--border); border-radius:12px; overflow:hidden; }
  .list .item{ display:flex; justify-content:space-between; align-items:center; padding:12px; border-top:1px solid var(--border); background:var(--card); }
  .list .item:first-child{ border-top:none; }
  .muted{ color:var(--muted); }

  /* Searchable dropdown */
  .sdd { position: relative; min-width:260px; }
  .sdd-btn { width: 100%; padding: 10px 12px; border:1px solid var(--border); border-radius: 10px; background: var(--card); color: var(--text); display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
  .sdd-panel { position:absolute; z-index:50; top: calc(100% + 6px); left:0; right:0; background:var(--card); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); display:none; max-height:320px; overflow:hidden; }
  .sdd.open .sdd-panel { display:block; }
  .sdd-search { padding:8px; border-bottom:1px solid var(--border); }
  .sdd-search input { width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:8px; background:var(--panel); color:var(--text); }
  .sdd-list { max-height:260px; overflow:auto; }
  .sdd-opt { padding:10px 12px; cursor:pointer; white-space:nowrap; text-overflow:ellipsis; overflow:hidden; }
  .sdd-opt:hover, .sdd-opt[aria-selected="true"]{ background: rgba(37,99,235,.08); }
  .sdd-kbd { font:12px/1 ui-monospace, SFMono-Regular, Menlo, monospace; color:var(--muted); }

  /* Modal */
  .modal-back{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; padding:24px; z-index:100; }
  .modal{ width:min(900px, 100%); background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); }
  .modal .hd{ padding:14px 16px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
  .modal .bd{ padding:16px; max-height:70vh; overflow:auto; }
  .modal .ft{ padding:12px 16px; border-top:1px solid var(--border); display:flex; gap:8px; justify-content:flex-end; }

  .tbl{ width:100%; border-collapse:collapse; }
  .tbl th, .tbl td { padding:8px 10px; border-bottom:1px solid var(--border); text-align:left; vertical-align:top; }
  .sec{ margin:12px 0 6px; font-weight:700; }
  .tag{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:700; }
  .ok{ background:rgba(22,163,74,.12); color:#0F5132; }
  .warn{ background:rgba(217,119,6,.14); color:#5F370E; }
  .bad{ background:rgba(239,68,68,.14); color:#7F1D1D; }

  /* Print only the modal when body has .print-modal */
  @media print {
    body.print-modal .wrap,
    body.print-modal #printList { display: none !important; }

    body.print-modal .modal-back {
      position: static !important;
      display: block !important;
      background: none !important;
      padding: 0 !important;
    }
    body.print-modal .modal {
      width: auto !important;
      box-shadow: none !important;
      border: none !important;
    }
    body.print-modal .modal .ft { display: none !important; } /* hide footer buttons */
  }

  /* (optional) nicer page setup */
  @page { margin: 12mm; }
  /* keep tables tidy on page breaks */
  @media print {
    .tbl { page-break-inside: auto; }
    .tbl tr { page-break-inside: avoid; page-break-after: auto; }
  }

  /* Print only the modal, but expand its content fully */
  @media print {
    body.print-modal .wrap,
    body.print-modal #printList { display: none !important; }

    body.print-modal .modal-back {
      position: static !important;
      display: block !important;
      background: none !important;
      padding: 0 !important;
    }

    body.print-modal .modal {
      position: static !important;
      width: auto !important;
      max-width: none !important;
      box-shadow: none !important;
      border: none !important;
      transform: none !important;
    }

    /* CRITICAL: remove scroll box so the whole popup prints */
    body.print-modal .modal .bd {
      max-height: none !important;
      overflow: visible !important;
    }

    /* nicer pagination for tables */
    body.print-modal .tbl { width:100% !important; table-layout:auto !important; }
    body.print-modal .tbl th,
    body.print-modal .tbl td { break-inside: avoid-page; }
    body.print-modal .modal .ft { display: none !important; }
  }

  @page { margin: 12mm; }

  </style>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
      <div class="h1" style="margin:0">View Vessel</div>
      <button id="btnBack" class="btn alt small" type="button" aria-label="Back to Dashboard">← Back</button>
    </div>

    <div class="cards">
      <!-- Card 1: Search (only for super/admin/staff group) -->
      <div id="cardSearch" class="card" style="display:none">
        <div class="row" style="margin-bottom:8px"><strong>Search vessel</strong><span class="muted">Filter by Ship Name or Owner Name</span></div>
        <div class="row">
          <div class="field">
            <label>Ship Name</label>
            <div id="sddShip" class="sdd"></div>
          </div>
          <div class="field">
            <label>Owner Name</label>
            <div id="sddOwner" class="sdd"></div>
          </div>
          <div class="field" style="align-self:flex-end">
            <button id="btnClear" class="btn alt">Clear</button>
          </div>
        </div>
      </div>

      <!-- Card 2: Vessel list -->
      <div class="card">
        <div class="row" style="margin-bottom:8px;justify-content:space-between;align-items:center">
          <div><strong>Vessels</strong> <span class="muted" id="vCount"></span></div>
          <div class="row">
            <button id="btnExportCsv" class="btn alt small" type="button">Export CSV</button>
            <button id="btnExportPdf" class="btn alt small" type="button">Export PDF</button>
          </div>
        </div>
        <div id="vList" class="list"></div>
      </div>
    </div>

    <!-- hidden printable list container -->
    <div id="printList" class="card" style="display:none"></div>
  </div>

  <!-- Modal -->
  <div id="modalBack" class="modal-back" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="hd">
        <div><strong id="mTitle">Vessel Detail</strong></div>
        <div class="muted" id="mSub"></div>
      </div>
      <div class="bd" id="mBody"></div>
      <div class="ft">
        <button id="btnPrint" class="btn alt">Print</button>
        <button id="btnClose" class="btn">Close</button>
      </div>
    </div>
  </div>

  <script>
  // ===== bootstrap =====
  const token     = "<?= token ?>";
  const appUrl    = "<?= appUrl ?>";
  const userLevel = "<?= userLevel ?>";
  const userGroup = "<?= userGroup ?>";
  const username  = "<?= username ?>";

  // ===== tiny helpers =====
  const $ = (id)=>document.getElementById(id);
  const on = (el, ev, fn)=> el && el.addEventListener(ev, fn);
  function el(tag, cls, html){ const x=document.createElement(tag); if(cls) x.className=cls; if(html!=null) x.innerHTML=html; return x; }

  // Pretty label: POWER_KW -> Power Kw; SIZE_OF_BORE -> Size Of Bore
  function prettyLabel(key){
    if (!key) return '';
    return String(key)
      .replaceAll('_',' ')
      .toLowerCase()
      .replace(/\b\w/g, c => c.toUpperCase());
  }

  // ===== print helpers =====
  function printModalOnly(){
    // enter print mode
    document.body.classList.add('print-modal');

    // Let styles apply, then print
    requestAnimationFrame(() => {
      window.print();
      // exit print mode after the dialog is shown
      setTimeout(() => document.body.classList.remove('print-modal'), 50);
    });
  }

  on($('btnPrint'), 'click', printModalOnly);

  // ===== searchable dropdown =====
  function sdd(container, items, {placeholder='Select...', onChoose}={}){
    container.innerHTML = '';
    const wrap = el('div','sdd');
    const btn  = el('button','sdd-btn'); btn.type='button';
    const lab  = el('span','',placeholder);
    const kbd  = el('span','sdd-kbd','/ to search');
    btn.append(lab,kbd);
    const panel = el('div','sdd-panel');
    panel.innerHTML = `
      <div class="sdd-search"><input type="text" placeholder="Type to search…"></div>
      <div class="sdd-list" role="listbox"></div>
    `;
    wrap.append(btn,panel); container.append(wrap);
    const input = panel.querySelector('input'); const list = panel.querySelector('.sdd-list');
    let filtered = items.slice(); let active = -1;

    function render(){
      list.innerHTML = '';
      if (!filtered.length){ list.append(el('div','sdd-opt','No matches')); return; }
      filtered.forEach((t,i)=> {
        const it = el('div','sdd-opt', t); if(i===active) it.setAttribute('aria-selected','true');
        on(it,'click',()=> choose(t)); list.append(it);
      });
    }
    function open(){ wrap.classList.add('open'); input.value=''; filtered=items.slice(); active=-1; render(); setTimeout(()=>input.focus(),0); }
    function close(){ wrap.classList.remove('open'); }
    function choose(val){ lab.textContent = val || placeholder; close(); onChoose && onChoose(val); }
    function filter(q){ const n=(q||'').toLowerCase(); filtered = items.filter(t => (t||'').toLowerCase().includes(n)); active=-1; render(); }

    on(btn,'click', ()=> wrap.classList.contains('open') ? close() : open());
    on(document,'click', (e)=> { if (!wrap.contains(e.target)) close(); });
    on(input,'input', e=> filter(e.target.value));
    on(input,'keydown', e=>{
      if (e.key==='Escape'){ close(); btn.focus(); }
      else if (e.key==='ArrowDown'){ e.preventDefault(); active = Math.min(filtered.length-1, active+1); render(); }
      else if (e.key==='ArrowUp'){ e.preventDefault(); active = Math.max(0, active-1); render(); }
      else if (e.key==='Enter'){ e.preventDefault(); if (filtered.length && active>=0) choose(filtered[active]); }
    });
    document.addEventListener('keydown', (e)=>{ if (document.activeElement===btn && e.key==='/'){ e.preventDefault(); open(); } });
    return { set:(val)=> lab.textContent = val || placeholder };
  }

  // ===== state =====
  let VIEWER = { group:null, level:null, canSearch:false };
  let ALL = [];         // [{SHIP_ID, SHIP_NAME, OWNER_NAME}]
  let FILTER = { ship:'', owner:'' };
  let sddShip, sddOwner;

  function uniqueSorted(arr){ return Array.from(new Set(arr.filter(Boolean).map(s=>s.trim()))).sort((a,b)=>a.localeCompare(b,undefined,{sensitivity:'base'})); }

  function filteredRows(){
    return ALL.filter(v => (!FILTER.ship || v.SHIP_NAME===FILTER.ship) && (!FILTER.owner || v.OWNER_NAME===FILTER.owner));
  }

  function drawList(){
    const box = $('vList'); box.innerHTML='';
    const rows = filteredRows();
    $('vCount').textContent = `${rows.length} vessel(s)`;
    if (!rows.length){ box.append(el('div','item','<span class="muted">No vessels found</span>')); return; }
    rows.forEach(v=>{
      const left = `<div><div><strong>${v.SHIP_NAME}</strong></div><div class="muted">${v.OWNER_NAME}</div></div>`;
      const btns = `
        <div class="row">
          <button class="btn small" data-view="${v.SHIP_ID}">View Detail</button>
        </div>`;
      const item = el('div','item', left + btns);
      box.append(item);
    });
    box.querySelectorAll('button[data-view]').forEach(b => on(b,'click', ()=> openDetail(b.getAttribute('data-view'))));
  }

  function applyFilters(){ drawList(); }

  function buildSearchUI(){
    $('cardSearch').style.display = VIEWER.canSearch ? '' : 'none';
    if (!VIEWER.canSearch) return;
    const ships  = uniqueSorted(ALL.map(v=>v.SHIP_NAME));
    const owners = uniqueSorted(ALL.map(v=>v.OWNER_NAME));
    sddShip  = sdd($('sddShip'), ships,  { placeholder:'Select ship…',  onChoose:(val)=>{ FILTER.ship = val || ''; applyFilters(); }});
    sddOwner = sdd($('sddOwner'), owners, { placeholder:'Select owner…', onChoose:(val)=>{ FILTER.owner = val || ''; applyFilters(); }});
    on($('btnClear'), 'click', ()=>{ FILTER.ship = ''; FILTER.owner=''; sddShip.set(''); sddOwner.set(''); applyFilters(); });
  }

  // Back to dashboard
  on(document, 'DOMContentLoaded', () => {
    const btn = $('btnBack');
    if (btn) on(btn, 'click', () => {
      const base = appUrl || '';
      const url  = `${base}?page=dashboard&token=${encodeURIComponent(token)}`;
      window.top.location.href = url;
    });
  });

  // ===== expiry helpers =====
  function statusOf(expiryStr){
    if (!expiryStr) return {key:'VALID', cls:'ok'};
    const today = new Date(); today.setHours(0,0,0,0);
    const exp   = new Date(expiryStr);
    if (isNaN(exp.getTime())) return {key:'VALID', cls:'ok'};
    const diffDays = Math.floor((exp - today)/(1000*60*60*24));
    if (diffDays < 0) return {key:'INVALID', cls:'bad'};
    if (diffDays <= 60) return {key:'PENDING', cls:'warn'};
    return {key:'VALID', cls:'ok'};
  }
  function daysLeft(expiryStr){
    if (!expiryStr) return '';
    const today = new Date(); today.setHours(0,0,0,0);
    const exp   = new Date(expiryStr);
    if (isNaN(exp.getTime())) return '';
    const diffDays = Math.floor((exp - today)/(1000*60*60*24));
    return String(diffDays);
  }

  function sortByStatus(items){
    const order = { INVALID:0, PENDING:1, VALID:2 };
    return items.slice().sort((a,b)=>{
      const A = statusOf(a['DATE_EXPIRY']).key, B = statusOf(b['DATE_EXPIRY']).key;
      if (order[A] !== order[B]) return order[A] - order[B];
      const da = new Date(a['DATE_EXPIRY']).getTime() || Infinity;
      const db = new Date(b['DATE_EXPIRY']).getTime() || Infinity;
      return da - db;
    });
  }

  // ===== renderers =====
  function renderEngines(engines){
    const rows = Array.isArray(engines) ? engines : [];
    if (!rows.length) return '<div class="muted">No engine records</div>';

    // Collect union of keys (excluding SHIP_ID)
    const allKeysSet = new Set();
    rows.forEach(r => Object.keys(r||{}).forEach(k => { if (k !== 'SHIP_ID') allKeysSet.add(k); }));
    const allKeys = Array.from(allKeysSet);

    // Bring useful columns forward if they exist
    const prefer = ['ENGINE_NO','ENGINE_NAME','ENGINE_TYPE','ENGINE_MODEL','POWER','POWER_HP','POWER_KW'];
    allKeys.sort((a,b)=>{
      const ia = prefer.includes(a) ? prefer.indexOf(a) : Number.MAX_SAFE_INTEGER;
      const ib = prefer.includes(b) ? prefer.indexOf(b) : Number.MAX_SAFE_INTEGER;
      if (ia !== ib) return ia - ib;
      return a.localeCompare(b);
    });

    const thead = `<thead><tr>${allKeys.map(k=>`<th>${prettyLabel(k)}</th>`).join('')}</tr></thead>`;
    const tbody = `<tbody>${
      rows.map(r => `<tr>${allKeys.map(k => `<td>${(r[k]??'-')}</td>`).join('')}</tr>`).join('')
    }</tbody>`;

    return `<table class="tbl">${thead}${tbody}</table>`;
  }

  function invDisplayName(it){
    const sub  = String(it?.['SUB_CATEGORY'] ?? '').trim();
    const name = String(it?.['NAME'] ?? '').trim();
    if (!name) return '-';
    return sub ? `${sub} ${name}` : name;
  }

  function renderDetail(detail){
    const m = detail.main || {};
    const inv = Array.isArray(detail.inventory) ? sortByStatus(detail.inventory) : [];

    const mainTbl = `
      <div class="sec">Vessel Main Info</div>
      <table class="tbl">
        <tr><th>Ship Name</th><td>${m.SHIP_NAME||'-'}</td></tr>
        <tr><th>Owner Name</th><td>${m.OWNER_NAME||'-'}</td></tr>
        <tr><th>Official Number</th><td>${m.OFFICIAL_NUMBER||'-'}</td></tr>
        <tr><th>IMO Number</th><td>${m.IMO_NUMBER||'-'}</td></tr>
        <tr><th>Ship Type</th><td>${m.SHIP_TYPE||'-'}</td></tr>
      </table>`;

    const propRows = (detail.prop||[]).map(p=>{
      const out = Object.entries(p)
        .filter(([k])=>k!=='SHIP_ID')
        .map(([k,v])=>`<tr><th>${prettyLabel(k)}</th><td>${v||'-'}</td></tr>`)
        .join('');
      return `<table class="tbl">${out || '<tr><td class="muted">No data</td></tr>'}</table>`;
    }).join('') || '<div class="muted">No propulsion records</div>';

    // Engines — consolidated printable table with pretty headers
    const enginesTbl = `
      <div class="sec">Vessel Engine Info</div>
      ${renderEngines(detail.engines||[])}
    `;

    // Inventory (with Day(s) Left column)
    const invRows = inv.map(it=>{
      const s = statusOf(it['DATE_EXPIRY']);
      const d = daysLeft(it['DATE_EXPIRY']);
      return `<tr>
        <td>${it['NAME']||'-'}</td>
        <td>${it['DESCRIPTION']||'-'}</td>
        <td>${it['QUANTITY']||'-'}</td>
        <td>${it['DATE_MANUFACTURED']||'-'}</td>
        <td>${it['DATE_EXPIRY']||'-'}</td>
        <td>${d}</td>
        <td><span class="tag ${s.cls}">${s.key}</span></td>
      </tr>`;
    }).join('') || `<tr><td colspan="7" class="muted">No inventory items</td></tr>`;

    const invTbl = `
      <div class="sec">Vessel Inventory</div>
      <table class="tbl">
        <thead><tr>
          <th>Name</th><th>Description</th><th>Qty</th>
          <th>Date Manufactured</th><th>Date Expiry</th><th>Day(s) Left</th><th>Status</th>
        </tr></thead>
        <tbody>${invRows}</tbody>
      </table>`;

    $('mBody').innerHTML = `
      ${mainTbl}
      <div class="sec">Vessel Propulsion System</div>
      ${propRows}
      ${enginesTbl}
      ${invTbl}
    `;
    $('mTitle').textContent = m.SHIP_NAME || 'Vessel Detail';
    $('mSub').textContent   = m.OWNER_NAME || '';
  }

  function openDetail(shipId){
    google.script.run
      .withSuccessHandler(res=>{
        if (!res?.ok){ alert(res?.msg || 'Failed to load detail'); return; }
        renderDetail(res);
        $('modalBack').style.display = 'flex';
        $('modalBack').setAttribute('aria-hidden','false');
      })
      .withFailureHandler(err=> alert(err?.message||'Unexpected error'))
      .getVesselDetail(token, shipId);
  }

  // Export helpers
  function toCSV(rows){
    const esc = s => `"${String(s??'').replace(/"/g,'""')}"`;
    const header = ['Ship Name','Owner Name','Ship ID'];
    const body = rows.map(r => [r.SHIP_NAME, r.OWNER_NAME, r.SHIP_ID]);
    return [header, ...body].map(r => r.map(esc).join(',')).join('\n');
  }
  function downloadFile(filename, content, mime){
    const blob = new Blob([content], {type: mime || 'text/plain'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename;
    document.body.appendChild(a); a.click(); URL.revokeObjectURL(a.href); a.remove();
  }
  function exportCSV(){
    const rows = filteredRows();
    const d = new Date().toISOString().slice(0,10);
    downloadFile(`vessels_${d}.csv`, toCSV(rows), 'text/csv');
  }
  function exportPDF(){
    const rows = filteredRows();
    const tblRows = rows.map(r => `<tr><td>${r.SHIP_NAME||'-'}</td><td>${r.OWNER_NAME||'-'}</td><td>${r.SHIP_ID||'-'}</td></tr>`).join('')
      || `<tr><td colspan="3" class="muted">No vessels</td></tr>`;
    $('printList').innerHTML = `
      <h2 style="margin-top:0">Vessels</h2>
      <table class="tbl">
        <thead><tr><th>Ship Name</th><th>Owner Name</th><th>Ship ID</th></tr></thead>
        <tbody>${tblRows}</tbody>
      </table>`;
    document.body.classList.add('print-list');
    window.print();
    setTimeout(()=>{ document.body.classList.remove('print-list'); $('printList').innerHTML=''; }, 200);
  }

  // modal buttons
  on($('btnPrint'), 'click', printModalOnly);
  on($('btnClose'), 'click', ()=>{
    $('modalBack').style.display = 'none';
    $('modalBack').setAttribute('aria-hidden','true');
  });

  // ===== init =====
  document.addEventListener('DOMContentLoaded', ()=>{
    google.script.run
      .withSuccessHandler(res=>{
        if (!res?.ok){ alert(res?.msg || 'Failed to load vessels'); return; }
        VIEWER = res.viewer || {canSearch:false};
        ALL = Array.isArray(res.vessels) ? res.vessels : [];
        buildSearchUI();
        drawList();

        // wire export buttons
        on($('btnExportCsv'), 'click', exportCSV);
        on($('btnExportPdf'), 'click', exportPDF);

        // auto-open from URL (?shipId=..&open=1[&print=1])
        const url = new URL(window.location.href);
        const shipIdParam = url.searchParams.get('shipId');
        const openParam   = url.searchParams.get('open');
        const printParam  = url.searchParams.get('print');
        if (shipIdParam && openParam === '1' && ALL.some(v => String(v.SHIP_ID) === String(shipIdParam))) {
          openDetail(shipIdParam);
          if (printParam === '1') setTimeout(()=> window.print(), 350);
        }
      })
      .withFailureHandler(err=> alert(err?.message||'Unexpected error'))
      .listVesselsForUser(token);
  });

  window.addEventListener('error', e => {
    console.error('JS Error:', e.message, e.filename, e.lineno);
  });
  </script>
</body>
</html>