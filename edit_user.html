<!doctype html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Cache-Control" content="no-store, max-age=0">
  <title>NAVI-SIMS — Edit User</title>
  <style>
/* ===== NAVI-SIMS Design System (edit user) ===== */
:root{
  --bg:#F6F7FB; --card:#ffffff; --panel:#F9FAFB; --text:#0F172A; --muted:#64748B;
  --border:#E5E7EB; --ring:#2563EB; --primary:#2563EB; --danger:#EF4444;
  --radius:18px; --shadow:0 10px 30px rgba(2,6,23,.08);
}
@media (prefers-color-scheme: dark){
  :root{ --bg:#0B1220; --card:#0F172A; --panel:#111827; --text:#E5E7EB; --muted:#94A3B8; --border:#1F2937; --primary:#60A5FA; --shadow:0 10px 30px rgba(0,0,0,.45) }
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);min-height:100vh;display:flex;align-items:center;justify-content:center;font:400 16px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;}
.wrap{width:min(96vw,1100px)}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:26px;box-shadow:var(--shadow)}
.title{display:flex;align-items:center;gap:14px;margin-bottom:8px}
.logo-banner{width:min(38vw,200px);height:auto;display:block;object-fit:contain;background:#fff;border-radius:10px;box-shadow:0 0 0 1px var(--border), 0 3px 12px rgba(0,0,0,.06)}
.muted{color:var(--muted)}
.grid{display:grid;grid-template-columns:1fr;gap:16px}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px}
.panel h3{margin:0 0 10px;font-size:1.04rem}
label{font-size:.9rem;color:var(--muted);display:block;margin:8px 0 6px}
input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;outline:none;background:#fff}
@media (prefers-color-scheme: dark){ input,select,textarea{background:#0F172A;color:var(--text)} }
input:focus,select:focus,textarea:focus{border-color:var(--ring);box-shadow:0 0 0 4px color-mix(in oklab, var(--ring) 18%, transparent)}
input,select{height:44px}
textarea{min-height:92px;resize:vertical}
.row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.btn{background:var(--primary);color:#fff;border:none;border-radius:12px;padding:10px 14px;cursor:pointer}
.btn.alt{background:#334155;color:#fff}
.btn.soft{background:#E5E7EB;color:#111827}
.btn.danger{background:var(--danger)}
.msg{margin-top:10px;display:none;padding:10px;border-radius:10px}
.msg.ok{background:#E6FFED;color:#065F46;border:1px solid #A7F3D0}
.msg.err{background:#FEE2E2;color:#991B1B;border:1px solid #FECACA}
.hint,.note{font-size:.8rem;color:var(--muted)}
.note a{color:var(--primary);text-decoration:none}
.note a:hover{text-decoration:underline}
.pager-top { display:flex; align-items:center; justify-content:space-between; gap:10px; margin:-6px 0 10px; }
.steps { display:flex; gap:6px; align-items:center; }
.step-dot { width:9px; height:9px; border-radius:50%; background:#CBD5E1; border:1px solid #94A3B8; }
.step-dot.active { background:var(--primary); border-color:var(--primary); }
#detailsPager .page { display:none; }
#detailsPager .page.active { display:block; }
.pager-controls { display:flex; gap:10px; margin-top:12px; }
.pager-controls .btn.soft { background:#E5E7EB; color:#111827; }
@media (prefers-color-scheme: dark){
  .step-dot{ background:#1F2937; border-color:#374151 }
  .step-dot.active{ background:var(--primary); border-color:var(--primary) }
}
</style>
</head>
<body>
  <script src="js/api.js"></script>
  <script src="js/nav.js"></script>
  <script>requireAuth();</script>
  <div class="wrap">
    <div class="card">
      <div class="title">
        <img class="logo-banner" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='60'%3E%3Crect fill='%232563EB' width='200' height='60'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='white' font-family='Arial' font-size='18' font-weight='bold'%3ENAVI-SIMS%3C/text%3E%3C/svg%3E" alt="Logo">
        <div>
          <h2 style="margin:0">Edit User</h2>
          <div class="muted" id="userLevelDisplay">Loading...</div>
        </div>
        <button id="btnBack" class="btn alt" type="button" style="margin-left:auto">Back</button>
      </div>

      <div class="grid">
        <div class="panel" id="card0">
          <h3>Find User</h3>
          <label for="selUser">Select User</label>
          <select id="selUser"><option value="">— Loading… —</option></select>
          <div class="note">Admins see only Level 1 & 2 users.</div>
          <div id="msg0Ok" class="msg ok"></div>
          <div id="msg0Err" class="msg err"></div>
        </div>

        <div class="panel" id="card1" style="display:none;">
          <h3>Login Information</h3>
          <div class="hint">Editing USER_ID <span id="hUserId"></span></div>

          <label>USER_ID</label>
          <input id="userIdDisplay" type="text" disabled>

          <label for="username">Username</label>
          <input id="username" type="text" required readonly>

          <label for="password">New Password (leave blank to keep current)</label>
          <div class="row">
            <input id="password" type="password" placeholder="••••••••" style="flex:1">
            <button id="togglePw" class="btn soft" type="button">Show</button>
            <button id="btnDelete" class="btn danger" type="button" style="margin-left:auto">Delete User</button>
          </div>

          <label for="level">User Level</label>
          <select id="level" required></select>

          <label for="group">User Group</label>
          <select id="group" required></select>

          <div class="row">
            <button id="btnSave1"  class="btn"     type="button">Save</button>
            <button id="btnReset1" class="btn alt" type="button">Reset</button>
          </div>

          <div id="msg1Ok" class="msg ok"></div>
          <div id="msg1Err" class="msg err"></div>
        </div>

        <div class="panel" id="card2" style="display:none;">
          <div class="pager-top">
            <h3 id="card2Title" style="margin:0">Details</h3>
            <div class="steps" id="steps"></div>
          </div>

          <div id="detailsPager"></div>

          <div class="pager-controls">
            <button id="btnPrev" class="btn soft" type="button">← Prev</button>
            <button id="btnNext" class="btn soft" type="button" style="margin-left:auto">Next →</button>
          </div>

          <div class="row">
            <button id="btnSave2"  class="btn"     type="button">Save</button>
            <button id="btnReset2" class="btn alt" type="button">Reset</button>
          </div>
          <div id="msg2Ok" class="msg ok"></div>
          <div id="msg2Err" class="msg err"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
  const params = new URLSearchParams(window.location.search);
  const token = params.get('token') || localStorage.getItem('navi_token') || '';

  if (!token) {
    window.location.href = 'login.html?err=' + encodeURIComponent('Session expired');
  }

  // Load user session dynamically if needed
  let userInfo = null;
  async function loadSession() {
    try {
      const res = await API.getUserSessionInfo(token);
      if (res?.ok) userInfo = res.user;
    } catch (err) {
      console.error('Session load failed:', err);
    }
  }

  const ALLOWED_MIME = new Set(['application/pdf','application/msword','application/vnd.openxmlformats-officedocument.wordprocessingml.document','application/vnd.ms-excel','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet','application/vnd.ms-powerpoint','application/vnd.openxmlformats-officedocument.presentationml.presentation','text/plain','image/jpeg','image/png','image/gif','image/webp','image/heic','image/heif','image/bmp','image/tiff']);
  const ALLOWED_EXT = new Set(['pdf','doc','docx','xls','xlsx','ppt','pptx','txt','jpg','jpeg','png','gif','webp','heic','heif','bmp','tif','tiff']);
  const MAX_FILE_MB = 15;

  function isAllowedFile(file) {
    if (!file) return false;
    const mimeOk = ALLOWED_MIME.has((file.type || '').toLowerCase());
    const ext = (file.name.split('.').pop() || '').toLowerCase();
    const extOk = ALLOWED_EXT.has(ext);
    const sizeOk = (file.size || 0) <= MAX_FILE_MB * 1024 * 1024;
    return (mimeOk || extOk) && sizeOk;
  }

  function explainFileProblem(file) {
    if (file && file.size > MAX_FILE_MB * 1024 * 1024) return `File too large (>${MAX_FILE_MB} MB): ${file.name}`;
    return `Unsupported type: ${file ? file.name : '(none)'}`;
  }

  let LEVELS = [], GROUPS = [];
  let CUR_USER_ID = null, CUR_GROUP_ID = null, DETAIL_SCHEMA = null, SNAPSHOT_BASIC = null;
  let DIRTY1 = false, DIRTY2 = false;

  const $ = (id) => document.getElementById(id);
  const on = (el, ev, fn) => { if (el) el.addEventListener(ev, fn); };

  function setMsg(which, ok, text) {
    const okBox  = $(`msg${which}Ok`), errBox = $(`msg${which}Err`);
    if (okBox) okBox.style.display = 'none'; if (errBox) errBox.style.display = 'none';
    if (ok)  { if (okBox)  { okBox.textContent = text; okBox.style.display = 'block'; } }
    else     { if (errBox) { errBox.textContent = text; errBox.style.display = 'block'; } }
  }

  function fileToBase64(file){return new Promise((res,rej)=>{const fr=new FileReader();fr.onload=()=>res(fr.result);fr.onerror=rej;fr.readAsDataURL(file);});}
  function renderFileRef(v){const id=/^[A-Za-z0-9_-]{20,}$/.test(String(v));return id?`<a href="https://drive.google.com/file/d/${v}/view" target="_blank" rel="noopener">open</a>`:String(v||'');}

  function fillSelect(sel, options, valueToSet) {
    if (!sel) return;
    sel.innerHTML = options.map(o => `<option value="${String(o.id)}">${o.id} — ${o.name}</option>`).join('');
    const want = String(valueToSet ?? '').trim(); sel.value = want;
    if (sel.value !== want && want !== '') { const opt=document.createElement('option'); opt.value=want; opt.textContent=want; sel.prepend(opt); sel.value=want; }
  }

  const PAGE_SIZE = 8;
  let currentPage = 0, totalPages = 0;

  function renderSteps(container, count) {
    if (!container) return;
    container.innerHTML = '';
    for (let i = 0; i < count; i++) {
      const dot = document.createElement('div');
      dot.className = 'step-dot' + (i === currentPage ? ' active' : '');
      dot.dataset.index = i;
      dot.title = `Step ${i+1} of ${count}`;
      dot.addEventListener('click', () => goToPage(i));
      container.appendChild(dot);
    }
  }

  function goToPage(n) {
    const pages = document.querySelectorAll('#detailsPager .page');
    if (!pages.length) return;
    currentPage = Math.max(0, Math.min(n, pages.length - 1));
    pages.forEach((p, i) => p.classList.toggle('active', i === currentPage));
    $('btnPrev').disabled = (currentPage === 0);
    $('btnNext').disabled = (currentPage === pages.length - 1);
    renderSteps($('steps'), pages.length);
  }

  function wirePagerKeysOnce() {
    if (document.body.dataset.pagerKeysWired === '1') return;
    document.addEventListener('keydown', (e) => {
      if ($('card2').style.display === 'none') return;
      if (e.key === 'ArrowRight' && currentPage < totalPages - 1) goToPage(currentPage + 1);
      if (e.key === 'ArrowLeft'  && currentPage > 0)             goToPage(currentPage - 1);
    });
    document.body.dataset.pagerKeysWired = '1';
  }

  function buildDetailsFormWithValues(schema) {
    const pager = $('detailsPager');
    if (!pager) return;

    const cols = schema.columns || [];
    const fileCols = new Set(schema.fileColumns || []);
    const existing = schema.existing || {};

    const pieces = cols.map(col => {
      const label = col.replace(/_/g,' ');
      if (fileCols.has(col)) {
        const cur = existing[col] != null ? String(existing[col]) : '';
        const noteHtml = cur ? `<div class="note">Current: ${renderFileRef(cur)}</div>` : '';
        return `<label data-col="${col}">${label}</label><input type="file" data-col="${col}" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.jpg,.jpeg,.png,.gif,.webp,.heic,image/*">${noteHtml}`;
      } else {
        const val = existing[col] != null ? String(existing[col]) : '';
        const isTextArea = /ADDRESS/i.test(col);
        if (isTextArea) return `<label data-col="${col}">${label}</label><textarea data-col="${col}">${val}</textarea>`;
        const type = /EMAIL/i.test(col) ? 'email' : (/PHONE|CONTACT/i.test(col) ? 'tel' : 'text');
        return `<label data-col="${col}">${label}</label><input type="${type}" data-col="${col}" value="${val}">`;
      }
    });

    pager.innerHTML = '';
    totalPages = Math.ceil(pieces.length / PAGE_SIZE) || 1;

    for (let i = 0; i < totalPages; i++) {
      const page = document.createElement('div');
      page.className = 'page';
      page.dataset.page = i;
      page.innerHTML = pieces.slice(i * PAGE_SIZE, (i + 1) * PAGE_SIZE).join('');
      pager.appendChild(page);
    }

    currentPage = 0;
    goToPage(0);
    wirePagerKeysOnce();
  }

  async function loadUserById(id) {
    setMsg(0,true,''); setMsg(0,false,'');
    try {
      const res = await API.getUserBasic(token, id);
      if (!res || !res.ok) { setMsg(0,false,(res&&res.msg)||'Not found.'); return; }
      const b = res.basic;

      CUR_USER_ID  = b.USER_ID;
      CUR_GROUP_ID = String(b.USER_GROUP || '').trim();
      SNAPSHOT_BASIC = b;

      $('hUserId').textContent = CUR_USER_ID;
      $('userIdDisplay').value = CUR_USER_ID;
      $('username').value = b.USERNAME || '';
      $('password').value = '';
      fillSelect($('level'),  LEVELS, (b.USER_LEVELID || ''));
      fillSelect($('group'),  GROUPS, CUR_GROUP_ID);
      $('card1').style.display = 'block';

      const schema = await API.getDetailFormSchemaWithValues(token, CUR_USER_ID, CUR_GROUP_ID);
      $('card2').style.display = 'block';
      if (!schema || !schema.ok) { setMsg(2,false,(schema&&schema.msg)||'Failed to load details.'); return; }
      DETAIL_SCHEMA = schema;
      buildDetailsFormWithValues(schema);
      $('card2Title').textContent = (CUR_GROUP_ID === '0') ? 'Client Details' : 'Staff Details';
      setMsg(2,true,'');
    } catch (err) {
      setMsg(0,false, err&&err.message?err.message:'Unexpected error.');
    }
  }

  document.addEventListener('DOMContentLoaded', async () => {
    // Load session info
    try {
      const sessRes = await API.getUserSessionInfo(token);
      if (sessRes?.ok && sessRes.user) {
        $('userLevelDisplay').textContent = `Your level: ${sessRes.user.levelName || '—'}`;
      }
    } catch (err) {
      console.error('Failed to load session:', err);
    }

    // Load levels & groups
    try {
      const lgRes = await API.getLevelGroupOptions();
      if (lgRes?.ok) {
        LEVELS = lgRes.levels || [];
        GROUPS = lgRes.groups || [];
      }
    } catch (err) {
      console.error('Failed to load level/group options:', err);
    }

    on($('btnBack'),'click',()=>{ 
      if(DIRTY1||DIRTY2){ if(!confirm('You have unsaved changes. Leave without saving?')) return; } 
      window.location.href = `dashboard.html?token=${encodeURIComponent(token)}`;
    });

    // Load user list
    try {
      const res = await API.getEditableUserList(token);
      const sel = $('selUser');
      if (!res || !res.ok) { sel.innerHTML = '<option value="">(Failed to load)</option>'; }
      else {
        const opts = ['<option value="">— Choose a user —</option>']
          .concat(res.users.map(u => `<option value="${u.userId}">${u.userId} — ${u.username} (Level ${u.levelId}: ${u.levelName})</option>`));
        sel.innerHTML = opts.join('');
      }
    } catch (err) {
      $('selUser').innerHTML = '<option value="">(Failed to load)</option>';
    }

    on($('selUser'),'change', (e)=>{ 
      const id = e.target.value; 
      if(!id) return; 
      if(DIRTY1||DIRTY2){ if(!confirm('You have unsaved changes. Switch user?')) return; } 
      loadUserById(id); 
    });

    on($('togglePw'),'click',()=>{
      const pw=$('password'); 
      if(!pw) return; 
      const hidden=pw.type==='password'; 
      pw.type=hidden?'text':'password'; 
      $('togglePw').textContent=hidden?'Hide':'Show';
    });

    ['password','level','group'].forEach(id=>{
      const el=$(id); if(!el)return; 
      on(el,'input',()=>{DIRTY1=true;}); 
      on(el,'change',()=>{DIRTY1=true;});
    });

    on($('btnSave1'),'click', async ()=>{
      setMsg(1,true,''); setMsg(1,false,'');
      if (!CUR_USER_ID) { setMsg(1,false,'Choose a user first.'); return; }
      const payload = {
        userId:  CUR_USER_ID,
        username: $('username').value.trim(),
        password: ($('password').value.trim() || null),
        levelId:  String(($('level')||{}).value || '').trim(),
        groupId:  String(($('group')||{}).value || '').trim()
      };
      try {
        const res = await API.updateUserBasic(token, payload);
        if(!res || !res.ok){ setMsg(1,false,(res&&res.msg)||'Failed to save.'); return; }
        setMsg(1,true,res.msg||'Saved.');
        DIRTY1=false;
        if (payload.groupId !== CUR_GROUP_ID) {
          CUR_GROUP_ID = payload.groupId;
          const schema = await API.getDetailFormSchemaWithValues(token, CUR_USER_ID, CUR_GROUP_ID);
          $('card2').style.display='block';
          if(!schema || !schema.ok){ setMsg(2,false,(schema&&schema.msg)||'Failed to load details.'); return; }
          DETAIL_SCHEMA=schema; buildDetailsFormWithValues(schema);
          $('card2Title').textContent = (CUR_GROUP_ID === '0') ? 'Client Details' : 'Staff Details';
          setMsg(2,true,'');
        }
        $('password').value='';
      } catch (err) {
        setMsg(1,false, err&&err.message?err.message:'Unexpected error.');
      }
    });

    on($('btnReset1'),'click',()=>{
      if(!SNAPSHOT_BASIC) return;
      $('userIdDisplay').value = SNAPSHOT_BASIC.USER_ID || '';
      $('username').value      = SNAPSHOT_BASIC.USERNAME || '';
      $('password').value      = '';
      fillSelect($('level'), LEVELS, (SNAPSHOT_BASIC.USER_LEVELID || ''));
      fillSelect($('group'), GROUPS, (SNAPSHOT_BASIC.USER_GROUP || ''));
      DIRTY1=false; setMsg(1,true,''); setMsg(1,false,'');
    });

    on($('btnDelete'),'click', async ()=>{
      if(!CUR_USER_ID){ setMsg(1,false,'Choose a user first.'); return; }
      if(!confirm(`Delete USER_ID ${CUR_USER_ID}? This removes login & details.`)) return;
      try {
        const res = await API.deleteUser(token, CUR_USER_ID);
        if(!res || !res.ok){ setMsg(1,false,(res&&res.msg)||'Delete failed.'); return; }
        alert('User deleted.');
        window.location.href = `dashboard.html?token=${encodeURIComponent(token)}`;
      } catch (err) {
        setMsg(1,false, err&&err.message?err.message:'Unexpected error.');
      }
    });

    on($('btnSave2'), 'click', async ()=>{
      setMsg(2,true,''); setMsg(2,false,'');
      if(!CUR_USER_ID || CUR_GROUP_ID==null || !DETAIL_SCHEMA){ setMsg(2,false,'Choose a user first.'); return; }
      const fileCols = new Set(DETAIL_SCHEMA.fileColumns || []);
      const values = {}, files = {};
      const controls = document.querySelectorAll('#detailsPager [data-col]');
      for (const el of controls) {
        const col = el.getAttribute('data-col'); 
        if (!col) continue;

        if (fileCols.has(col)) {
          const f = el.files && el.files[0];
          if (f) {
            if (!isAllowedFile(f)) {
              setMsg(2, false, explainFileProblem(f));
              return;
            }
            const b64 = await fileToBase64(f);
            files[col] = { name: f.name, mime: f.type, dataBase64: b64 };
          }
        } else {
          values[col] = (el.value || '').trim();
        }
      }

      try {
        const res = await API.saveDetailFormUpdate(token, { userId:CUR_USER_ID, groupId:CUR_GROUP_ID, values, files });
        if(!res || !res.ok){ setMsg(2,false,(res&&res.msg)||'Failed to save details.'); return; } 
        setMsg(2,true,res.msg||'Details saved.'); 
        DIRTY2=false;
      } catch (err) {
        setMsg(2,false, err&&err.message?err.message:'Unexpected error.');
      }
    });

    on($('btnReset2'),'click',()=>{ if(!DETAIL_SCHEMA) return; buildDetailsFormWithValues(DETAIL_SCHEMA); DIRTY2=false; setMsg(2,true,''); setMsg(2,false,''); });

    window.addEventListener('beforeunload', (e)=>{ if(DIRTY1||DIRTY2){ e.preventDefault(); e.returnValue=''; }});
  });
  </script>
</body>
</html>